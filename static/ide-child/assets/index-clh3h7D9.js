var Rt=Object.defineProperty;var Lt=(i,e,s)=>e in i?Rt(i,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[e]=s;var Ct=(i,e,s)=>(Lt(i,typeof e!="symbol"?e+"":e,s),s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const B of document.querySelectorAll('link[rel="modulepreload"]'))N(B);new MutationObserver(B=>{for(const q of B)if(q.type==="childList")for(const V of q.addedNodes)V.tagName==="LINK"&&V.rel==="modulepreload"&&N(V)}).observe(document,{childList:!0,subtree:!0});function s(B){const q={};return B.integrity&&(q.integrity=B.integrity),B.referrerPolicy&&(q.referrerPolicy=B.referrerPolicy),B.crossOrigin==="use-credentials"?q.credentials="include":B.crossOrigin==="anonymous"?q.credentials="omit":q.credentials="same-origin",q}function N(B){if(B.ep)return;B.ep=!0;const q=s(B);fetch(B.href,q)}})();function decomposeLimbsBig(i,e,s=-1){const N=BigInt(i);s<=0&&(s=Math.ceil(N.toString(2).length/e));const B=[];let q=N;const V=BigInt(e),Y=(1n<<V)-1n;for(let it=0;it<s;it++)B.push(q&Y),q>>=V;return B}function decomposeLimbs(i,e,s=-1){return decomposeLimbsBig(i,e,s).map(N=>Number(N.toString()))}function seq(i,e=0,s=!1){const N=[];if(s)for(let B=0;B<i;B++)N[B]=e+i-1-B;else for(let B=0;B<i;B++)N[B]=e+B;return N}function rseq(i,e){return typeof e!="number"?seq(i,0,!0):seq(i,e-i+1,!0)}function genTags(i,e,s=0,N=!1){const B=[];if(N)for(let q=0;q<e;q++)B[q]=i+(s+e-1-q);else for(let q=0;q<e;q++)B[q]=i+(s+q);return B}function randomNumberBits(i){return Math.floor(Math.random()*(1<<i>>>0))}function randomBigIntBits(i){if(i<=32)return BigInt(Math.floor(Math.random()*Math.pow(2,i)));let e=0n,s=i;for(;s>=32;)e<<=32n,e|=BigInt(randomNumberBits(32)),s-=32;return s>0&&(e<<=BigInt(s),e|=BigInt(randomNumberBits(s))),e}function rotl$1(i,e,s){const N=BigInt(i),B=BigInt(s),q=BigInt(e)%B,V=N<<q|N>>B-q&(1n<<q)-1n;return typeof V=="bigint"?V:typeof V=="number"?Number(V):V}function rotr(i,e,s){const N=BigInt(i),B=BigInt(s),q=BigInt(e)%B,V=N>>q|(N&(1n<<q)-1n)<<B-q;return typeof V=="bigint"?V:typeof V=="number"?Number(V):V}function negate(i,e){const N=BigInt(i)^(1n<<BigInt(e))-1n;return typeof N=="bigint"?N:typeof N=="number"?Number(N):N}function splitBits(i,e){const s=[];let N=BigInt(i);for(let B=0;B<e;B++)s.push(Number(N&1n)),N>>=1n;return s}function bitsToBig(i){let e=0n;for(let s=0;s<i.length;s++)e<<=1n,e|=BigInt(i[s]?1:0);return e}function bitsToNum(i){return Number(bitsToBig(i))}const NULL_VALUE={_internal_isNullValue:!0};function leftPadString(i,e,s="0"){for(;i.length<e;)i=s+i;return i}function bigSeqOperation(i,e){let s=i[0];for(let N=1;N<i.length;N++)s=e(s,i[N]);return s}class BigIntLimbsConfig{constructor(e){this.limbSizes=e,this.numLimbs=e.length,this.totalBits=e.reduce((B,q)=>B+q,0),this.joinedMask=(1n<<BigInt(this.totalBits))-1n;const s=new LimbMathBigInt(this,this.joinedMask),N=new LimbMathBigInt(this);this.ops={big:s,num:new LimbMathProxy(s,B=>Number(B)),limbs:new LimbMathProxy(s,B=>this.resolveSplit(B)),bigLimbs:new LimbMathProxy(s,B=>this.resolveSplitBig(B))},this.opsNoMask={big:N,num:new LimbMathProxy(N,B=>Number(B)),limbs:new LimbMathProxy(N,B=>this.resolveSplit(B)),bigLimbs:new LimbMathProxy(N,B=>this.resolveSplitBig(B))}}resolveJoinedBig(e){return Array.isArray(e)?this.joinPartsBig(e):BigInt(e)}resolveJoined(e){return Number(this.resolveJoinedBig(e))}resolveSplitBig(e){return Array.isArray(e)?this.splitPartsBig(this.resolveJoined(e)):this.splitPartsBig(e)}resolveSplit(e){return this.resolveSplitBig(e).map(s=>Number(s))}splitPartsBig(e){let s=BigInt(e);const N=[];for(let B=0;B<this.limbSizes.length;B++){const q=this.limbSizes[this.limbSizes.length-1-B],V=(1n<<BigInt(q))-1n;N.push(s&V),s>>=BigInt(q)}return N.reverse()}splitParts(e){return this.splitPartsBig(e).map(s=>Number(s))}joinPartsBig(e){let s=0n;for(let N=0;N<this.limbSizes.length;N++)s<<=BigInt(this.limbSizes[N]),s|=BigInt(e[N]);return s}joinParts(e){return Number(this.joinPartsBig(e))}genRandomBig(){const e=[];for(let s=0;s<this.numLimbs;s++)e.push(randomBigIntBits(this.limbSizes[s]));return e}genRandom(){return this.genRandomBig().map(e=>Number(e))}joinedArrayToHex(e,s=!1){const N=this.totalBits*e.length;if(N%4!==0)throw new Error("cannot convert to hex, result is not a multiple of 4 bits");const B=N/4;let q=0n;const V=s?e.concat([]).reverse():e;for(let Y=e.length-1;Y>=0;Y--)q<<=BigInt(this.totalBits),q|=BigInt(V[Y]);return leftPadString(q.toString(16),B,"0")}limbsArrayToHex(e,s=!1){return this.joinedArrayToHex(e.map(N=>this.joinPartsBig(N)),s)}}class LimbMathBigInt{constructor(e,s){this.config=e,this.mask=s}normalize(e){return this.jb(e)}jb(e){return typeof this.mask=="bigint"?this.config.resolveJoinedBig(e)&this.mask:this.config.resolveJoinedBig(e)}jbNoMask(e){return this.config.resolveJoinedBig(e)}maskIfDefined(e){return typeof this.mask=="bigint"?e&this.mask:e}seqOperationJoinedBig(e,s){return this.maskIfDefined(bigSeqOperation(e.map(N=>this.jb(N)),s))}seqOperationJoinedBigMask(e,s){const N=this.maskIfDefined(bigSeqOperation(e.map(B=>this.jb(B)),s));return typeof this.mask=="bigint"?N&this.mask:N}binaryOperationJoinedBig(e,s){return s(this.jb(e[0]),this.jb(e[1]))}binaryOperationJoinedBigNoMaskLeft(e,s){return s(this.jbNoMask(e[0]),this.jb(e[1]))}binaryOperationJoinedBigNoMaskRight(e,s){return s(this.jb(e[0]),this.jbNoMask(e[1]))}add(...e){return this.seqOperationJoinedBig(e,(s,N)=>s+N)}sub(...e){return this.seqOperationJoinedBig(e,(s,N)=>s-N)}mul(...e){return this.seqOperationJoinedBig(e,(s,N)=>s*N)}div(...e){return this.seqOperationJoinedBig(e,(s,N)=>s/N)}or(...e){return this.seqOperationJoinedBig(e,(s,N)=>s|N)}xor(...e){return this.seqOperationJoinedBig(e,(s,N)=>s^N)}and(...e){return this.seqOperationJoinedBig(e,(s,N)=>s^N)}negate(e){return this.jb(e)^this.config.joinedMask}mod(e,s){return this.binaryOperationJoinedBig([e,s],(N,B)=>N%B)}lShift(e,s){return this.binaryOperationJoinedBig([e,s],(N,B)=>N<<B)}rShift(e,s){return this.binaryOperationJoinedBig([e,s],(N,B)=>N>>B)}rotl(e,s){return this.binaryOperationJoinedBig([e,s],(N,B)=>rotl$1(this.jb(N),this.jbNoMask(B),this.config.totalBits))}rotr(e,s){return this.binaryOperationJoinedBig([e,s],(N,B)=>rotr(this.jb(N),this.jbNoMask(B),this.config.totalBits))}eq(...e){return this.seqOperationJoinedBig(e,(s,N)=>s===N?s:NULL_VALUE)===e[0]}neq(...e){return this.seqOperationJoinedBig(e,(s,N)=>s!==N?s:NULL_VALUE)===e[0]}lt(e,s){return this.jbNoMask(e)<this.jbNoMask(s)}lte(e,s){return this.jbNoMask(e)<=this.jbNoMask(s)}gt(e,s){return this.jbNoMask(e)>this.jbNoMask(s)}gte(e,s){return this.jbNoMask(e)>=this.jbNoMask(s)}not(e){return this.negate(e)}}class LimbMathProxy{constructor(e,s){this.base=e,this.convertResult=s}add(...e){return this.convertResult(this.base.add(...e))}sub(...e){return this.convertResult(this.base.sub(...e))}mul(...e){return this.convertResult(this.base.mul(...e))}div(...e){return this.convertResult(this.base.div(...e))}or(...e){return this.convertResult(this.base.or(...e))}xor(...e){return this.convertResult(this.base.xor(...e))}and(...e){return this.convertResult(this.base.and(...e))}negate(e){return this.convertResult(this.base.negate(e))}not(e){return this.convertResult(this.base.not(e))}mod(e,s){return this.convertResult(this.base.mod(e,s))}lShift(e,s){return this.convertResult(this.base.lShift(e,s))}rShift(e,s){return this.convertResult(this.base.rShift(e,s))}rotl(e,s){return this.convertResult(this.base.rotl(e,s))}rotr(e,s){return this.convertResult(this.base.rotr(e,s))}eq(...e){return this.base.eq(...e)}neq(...e){return this.base.neq(...e)}lt(e,s){return this.base.lt(e,s)}lte(e,s){return this.base.lte(e,s)}gt(e,s){return this.base.gt(e,s)}gte(e,s){return this.base.gte(e,s)}normalize(e){return this.convertResult(this.base.normalize(e))}}function u8ArrayToHex(i){const e=[];for(let s=0,N=i.length;s<N;s++)e[s]=i[s]<16?"0"+i[s].toString(16):i[s].toString(16);return e.join("")}function hexToU8Array(i){let e=i.charAt(1)==="x"?i.substring(2):i;if(e.length%2===1)throw new Error("hex strings must have an even number of characters");const s=new Uint8Array(e.length/2);for(let N=0,B=e.length/2;N<B;N++)s[N]=parseInt(e.substring(N*2,N*2+2),16);return s}function swapEndianU32(i){return((i&255)<<24|(i&65280)<<8|(i&16711680)>>>8|i>>>24)>>>0}function swapEndianU16(i){return(i>>>8|(i&255)<<8)>>>0}function u32ArrayToHex(i){return i instanceof Uint32Array?u8ArrayToHex(new Uint8Array(i.buffer)):u8ArrayToHex(new Uint8Array(new Uint32Array(i.map(e=>Number(e)).map(e=>(e<0?e>>>0:e)&4294967295)).buffer))}function hexToU32Array(i,e=!1){const s=new Uint32Array(hexToU8Array(i).buffer);return e?swapEndianU32Array(s):s}function u16ArrayToHex(i){return i instanceof Uint16Array?u8ArrayToHex(new Uint8Array(i.buffer)):u8ArrayToHex(new Uint8Array(new Uint16Array(i.map(e=>Number(e)).map(e=>(e<0?e>>>0:e)&65535)).buffer))}function hexToU16Array(i,e=!1){const s=new Uint16Array(hexToU8Array(i).buffer);return e?swapEndianU16Array(s):s}function swapEndianU32Array(i){for(let e=0;e<i.length;e++)i[e]=swapEndianU32(i[e]);return i}function swapEndianU16Array(i){for(let e=0;e<i.length;e++)i[e]=swapEndianU16(i[e]);return i}function isZeroedArray(i){for(let e=0;e<i.length;e++)if(i[e]!==0)return!1;return!0}function isDataValidASCII(i){for(let e=0;e<i.length;e++)if(i[e]<0||i[e]>127)return!1;return!0}const K$1=[1116352408,1899447441,-1245643825,-373957723,961987163,1508970993,-1841331548,-1424204075,-670586216,310598401,607225278,1426881987,1925078388,-2132889090,-1680079193,-1046744716,-459576895,-272742522,264347078,604807628,770255983,1249150122,1555081692,1996064986,-1740746414,-1473132947,-1341970488,-1084653625,-958395405,-710438585,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,-2117940946,-1838011259,-1564481375,-1474664885,-1035236496,-949202525,-778901479,-694614492,-200395387,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,-2067236844,-1933114872,-1866530822,-1538233109,-1090935817,-965641998],algorithms={sha256:1};function createHash(i){if(i&&!algorithms[i]&&!algorithms[i.toLowerCase()])throw new Error("Digest method not supported");return new Hash}class Hash{constructor(){this.A=1779033703,this.B=-1150833019,this.C=1013904242,this.D=-1521486534,this.E=1359893119,this.F=-1694144372,this.G=528734635,this.H=1541459225,this._size=0,this._sp=0,(!sharedBuffer||sharedOffset>=8e3)&&(sharedBuffer=new ArrayBuffer(8e3),sharedOffset=0),this._byte=new Uint8Array(sharedBuffer,sharedOffset,80),this._word=new Int32Array(sharedBuffer,sharedOffset,20),sharedOffset+=80}update(e){if(typeof e=="string")return this._utf8(e);if(e==null)throw new TypeError("Invalid type: "+typeof e);const s=e.byteOffset,N=e.byteLength;let B=N/64|0,q=0;if(B&&!(s&3)&&!(this._size%64)){const Y=new Int32Array(e.buffer,s,B*16);for(;B--;)this._int32(Y,q>>2),q+=64;this._size+=q}if(e.BYTES_PER_ELEMENT!==1&&e.buffer){const Y=new Uint8Array(e.buffer,s+q,N-q);return this._uint8(Y)}return q===N?this:this._uint8(e,q)}_uint8(e,s){const{_byte:N,_word:B}=this,q=e.length;for(s=s|0;s<q;){const V=this._size%64;let Y=V;for(;s<q&&Y<64;)N[Y++]=e[s++];Y>=64&&this._int32(B),this._size+=Y-V}return this}_utf8(e){const{_byte:s,_word:N}=this,B=e.length;let q=this._sp;for(let V=0;V<B;){const Y=this._size%64;let it=Y;for(;V<B&&it<64;){let Z=e.charCodeAt(V++)|0;Z<128?s[it++]=Z:Z<2048?(s[it++]=192|Z>>>6,s[it++]=128|Z&63):Z<55296||Z>57343?(s[it++]=224|Z>>>12,s[it++]=128|Z>>>6&63,s[it++]=128|Z&63):q?(Z=((q&1023)<<10)+(Z&1023)+65536,s[it++]=240|Z>>>18,s[it++]=128|Z>>>12&63,s[it++]=128|Z>>>6&63,s[it++]=128|Z&63,q=0):q=Z}it>=64&&(this._int32(N),N[0]=N[16]),this._size+=it-Y}return this._sp=q,this}_int32(e,s){let{A:N,B,C:q,D:V,E:Y,F:it,G:Z,H:et}=this,ot=0;for(s=s|0;ot<16;)W[ot++]=swap32(e[s++]);for(ot=16;ot<64;ot++)W[ot]=gamma1(W[ot-2])+W[ot-7]+gamma0(W[ot-15])+W[ot-16]|0;for(ot=0;ot<64;ot++){const pt=et+sigma1(Y)+ch(Y,it,Z)+K$1[ot]+W[ot]|0,ct=sigma0(N)+maj(N,B,q)|0;et=Z,Z=it,it=Y,Y=V+pt|0,V=q,q=B,B=N,N=pt+ct|0}this.A=N+this.A|0,this.B=B+this.B|0,this.C=q+this.C|0,this.D=V+this.D|0,this.E=Y+this.E|0,this.F=it+this.F|0,this.G=Z+this.G|0,this.H=et+this.H|0}digest(e){const{_byte:s,_word:N}=this;let B=this._size%64|0;for(s[B++]=128;B&3;)s[B++]=0;if(B>>=2,B>14){for(;B<16;)N[B++]=0;B=0,this._int32(N)}for(;B<16;)N[B++]=0;const q=this._size*8,V=(q&4294967295)>>>0,Y=(q-V)/4294967296;return Y&&(N[14]=swap32(Y)),V&&(N[15]=swap32(V)),this._int32(N),e==="hex"?this._hex():this._bin()}_hex(){const{A:e,B:s,C:N,D:B,E:q,F:V,G:Y,H:it}=this;return hex32(e)+hex32(s)+hex32(N)+hex32(B)+hex32(q)+hex32(V)+hex32(Y)+hex32(it)}_bin(){const{A:e,B:s,C:N,D:B,E:q,F:V,G:Y,H:it,_byte:Z,_word:et}=this;return et[0]=swap32(e),et[1]=swap32(s),et[2]=swap32(N),et[3]=swap32(B),et[4]=swap32(q),et[5]=swap32(V),et[6]=swap32(Y),et[7]=swap32(it),Z.slice(0,32)}}const W=new Int32Array(64);let sharedBuffer,sharedOffset=0;const hex32=i=>(i+4294967296).toString(16).substr(-8),swapLE=i=>i<<24&4278190080|i<<8&16711680|i>>8&65280|i>>24&255,swapBE=i=>i,swap32=isBE()?swapBE:swapLE,ch=(i,e,s)=>s^i&(e^s),maj=(i,e,s)=>i&e|s&(i|e),sigma0=i=>(i>>>2|i<<30)^(i>>>13|i<<19)^(i>>>22|i<<10),sigma1=i=>(i>>>6|i<<26)^(i>>>11|i<<21)^(i>>>25|i<<7),gamma0=i=>(i>>>7|i<<25)^(i>>>18|i<<14)^i>>>3,gamma1=i=>(i>>>17|i<<15)^(i>>>19|i<<13)^i>>>10;function isBE(){return new Uint8Array(new Uint16Array([65279]).buffer)[0]===254}function sha256Buffer(i,e){const s=i instanceof ArrayBuffer?i:i.buffer,N=new Hash;return N.update(new Uint8Array(s)),e?N.digest(e):N.digest()}function sha256Hex(i,e){return sha256Buffer(hexToU8Array(i),e)}/*! noble-ripemd160 - MIT License (c) Paul Miller (paulmillr.com) */const rl=Uint8Array.from([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]),rr=Uint8Array.from([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),sl=Uint8Array.from([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),sr=Uint8Array.from([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),Kl=Uint32Array.from([0,1518500249,1859775393,2400959708,2840853838]),Kr=Uint32Array.from([1352829926,1548603684,1836072691,2053994217,0]);function rotl(i,e){return i<<e|i>>>32-e}function f$2(i,e,s,N){return i===0?e^s^N:i===1?e&s|~e&N:i===2?(e|~s)^N:i===3?e&N|s&~N:e^(s|~N)}class RIPEMD160{constructor(){this.h0=1732584193,this.h1=-271733879,this.h2=-1732584194,this.h3=271733878,this.h4=-1009589776,this.block=new Uint8Array(64),this.blockSize=64,this.offset=0,this.length=new Uint32Array(4),this.finalized=!1,this.view=new DataView(this.block.buffer)}update(e){if(this.finalized)throw new Error("Digest already called");const s=this.block;let N=0;for(;this.offset+e.length-N>=this.blockSize;){for(let B=this.offset;B<this.blockSize;)s[B++]=e[N++];this.compress(),this.offset=0}for(;N<e.length;)s[this.offset++]=e[N++];for(let B=0,q=e.length*8;q>0;B++){let V=this.length[B];V+=q,q=V/4294967296|0,q>0&&(V-=4294967296*q),this.length[B]=V}return this}compress(){const e=new Uint32Array(16);for(let ct=0;ct<16;ct++)e[ct]=this.view.getInt32(ct*4,!0);let s=this.h0|0,N=s,B=this.h1|0,q=B,V=this.h2|0,Y=V,it=this.h3|0,Z=it,et=this.h4|0,ot=et;for(let ct=0;ct<5;ct++){const _t=4-ct,mt=Kl[ct],kt=Kr[ct];for(let dt=0;dt<16;dt++){const gt=16*ct+dt,wt=rotl(s+f$2(ct,B,V,it)+e[rl[gt]]+mt,sl[gt])+et|0;s=et,et=it,it=rotl(V,10)|0,V=B,B=wt}for(let dt=0;dt<16;dt++){const gt=16*ct+dt,wt=rotl(N+f$2(_t,q,Y,Z)+e[rr[gt]]+kt,sr[gt])+ot|0;N=ot,ot=Z,Z=rotl(Y,10)|0,Y=q,q=wt}}const pt=this.h1+V+Z|0;this.h1=this.h2+it+ot|0,this.h2=this.h3+et+N|0,this.h3=this.h4+s+q|0,this.h4=this.h0+B+Y|0,this.h0=pt}digest(){if(this.finalized)throw new Error("Digest already called");this.finalized=!0,this.block[this.offset++]=128,this.offset>56&&(this.block.fill(0,this.offset,64),this.compress(),this.offset=0),this.block.fill(0,this.offset,56),this.view.setUint32(56,this.length[0],!0),this.view.setUint32(60,this.length[1],!0),this.compress();const e=new DataView(new ArrayBuffer(20));e.setInt32(0,this.h0,!0),e.setInt32(4,this.h1,!0),e.setInt32(8,this.h2,!0),e.setInt32(12,this.h3,!0),e.setInt32(16,this.h4,!0),this.block.fill(0),this.offset=0;for(let s=0;s<4;s++)this.length[s]=0;return new Uint8Array(e.buffer)}}function toHex(i){return Array.from(i).map(e=>e.toString(16).padStart(2,"0")).join("")}function utf8ToBytes(i){return new TextEncoder().encode(i)}function ripemd160(i){const e=new RIPEMD160;e.update(i instanceof Uint8Array?i:utf8ToBytes(i));const s=e.digest();return typeof i=="string"?toHex(s):s}function ripemd160Buffer(i,e){const s=i instanceof ArrayBuffer?i:i.buffer,N=new RIPEMD160;return N.update(new Uint8Array(s)),e==="hex"?toHex(N.digest()):N.digest()}function ripemd160Hex(i,e){return ripemd160Buffer(hexToU8Array(i),e)}const scriptHelpers={BigIntLimbsConfig,getLimbsConfig:i=>new BigIntLimbsConfig(i),seq,genTags,rseq,rotl:rotl$1,rotr,negate,randomBigIntBits,randomNumberBits,splitBits,bitsToBig,bitsToNum,u8ArrayToHex,hexToU8Array,u32ArrayToHex,hexToU32Array,u16ArrayToHex,hexToU16Array,swapEndianU16Array,swapEndianU32Array,swapEndianU32,swapEndianU16,sha256Buffer,sha256Hex,ripemd160Buffer,ripemd160Hex};var BitcoinVMCheckSigMode=(i=>(i[i.AlwaysSucceed=0]="AlwaysSucceed",i[i.StandardWithOverride=1]="StandardWithOverride",i[i.Standard=2]="Standard",i))(BitcoinVMCheckSigMode||{}),StackItemType=(i=>(i[i.Integer=0]="Integer",i[i.ByteArray=1]="ByteArray",i[i.String=2]="String",i[i.BigInt=3]="BigInt",i))(StackItemType||{});const DEFAULT_BITCOIN_EXECUTION_CONFIG={vmMode:"bitcoin",sigCheckMode:1},MATCH_ALL_DUMMY_SIGNATURES=["FAKESIGNATUREFAKESIGNATUREFAKESIGNATUREFAKESIGNATUREFAKESIGNATURE","FAKESIGNATURE","FAKE_SIGNATURE","DUMMY_SIGNATURE","FAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKEFAKE","FAKE_*","*****************************************************************","DUMMY_DUMMY_DUMMY_DUMMY_DUMMY_DUMMY_DUMMY_DUMMY_DUMMY_DUMMY_DUMMY"],MATCH_ALL_DUMMY_PREFIXES=["?","FAKE_","DUMMY_"];function isValidDummySignature(i,e){if(isDataValidASCII(e)&&(i.length===32||i.length===33)){const s=new TextDecoder().decode(e);if(MATCH_ALL_DUMMY_SIGNATURES.indexOf(s)!==-1)return!0;const N=u8ArrayToHex(i.length===32?i:i.subarray(1,33));if(s.substring(s.length-64,s.length)===N&&MATCH_ALL_DUMMY_PREFIXES.indexOf(s.substring(0,s.length-64))!==-1)return!0}return!1}function isBitIDEScript(i){var s;const e=(s=i.split("/").pop())==null?void 0:s.split(".").filter(N=>N);if(e&&e.length>1){const N=e.pop();if(N==="basm"||N==="bitide")return!0}return!1}function generateIndent(i,e){let s="";for(let N=0;N<i;N++)s+=e;return s}function formatBitcoinStackNumber(i){return`<${i}>`}function formatBitcoinStackItem(i){if(typeof i=="bigint")return`<0x${u8ArrayToHex(Array.from(bigIntToLEBytes(i)).reverse().concat([0,0,0,0,0,0,0,0]).slice(0,8).reverse())}>`;if(typeof i=="number")return formatBitcoinStackNumber(i);if(typeof i=="string")return`<${JSON.stringify(i)}>`;if(i instanceof Uint8Array)return`<0x${u8ArrayToHex(i)}>`;throw new Error(`Unable to convert type ${typeof i} to a bitcoin stack item`)}const INT64_MAX$1=0x7fffffffffffffffn,INT64_MIN$1=-0x8000000000000000n,INT32_MAX$1=2147483647,INT32_MIN$1=-2147483647;function bytesToScriptNumber(i){if(!i.length)return 0;let e=0n;for(let s=0;s<i.length;s++)e|=BigInt(i[s])<<BigInt(8*s);return i[i.length-1]&128?Number(-(e&~(0x80n<<BigInt(8*(i.length-1))))):Number(e)}function scriptNumberToLEBytes(i){const e=BigInt(i);if(e===0n)return new Uint8Array(0);const s=[],N=e<0n;let B=N?~e+1n:e;for(;B;)s.push(Number(B&0xffn)),B>>=8n;return s[s.length-1]&128?s.push(N?128:0):N&&(s[s.length-1]|=128),new Uint8Array(s)}function bigIntToLEBytes(i){return new Uint8Array(new BigUint64Array([i]).buffer)}function bigIntToLEBytesMin(i){if(i===0n)return new Uint8Array;const e=[],s=i<0;let N=s?-i:i;for(;N>0;)e.push(Number(N&0xffn)),N>>=8n;const B=128;return(e[e.length-1]&B)>0?e.push(s?B:0):s&&(e[e.length-1]|=B),new Uint8Array(e)}function stackItemToHex(i){if(typeof i=="number")return u8ArrayToHex(scriptNumberToLEBytes(i));if(typeof i=="bigint")return u8ArrayToHex(bigIntToLEBytes(i));if(typeof i=="string")return u8ArrayToHex(new TextEncoder().encode(i));if(typeof i=="object"&&i&&i instanceof Uint8Array)return u8ArrayToHex(i);throw new Error("unsupported stack item type: "+typeof i)}function convertStackItemToInt64(i){if(typeof i=="bigint"){if(i>INT64_MAX$1||i<INT64_MIN$1)throw new Error(`cannot convert bigint stack item ${formatBitcoinStackItem(i)} to a int64, must be between ${INT64_MIN$1} and ${INT64_MAX$1}`);return i}else{if(typeof i=="number")throw new Error(`cannot convert int32 stack item ${formatBitcoinStackItem(i)} to an int64, you must use OP_LE64TOSCRIPTNUM to convert it`);if(typeof i=="string")throw new Error(`cannot convert string stack item ${formatBitcoinStackItem(i)} to a int64`);if(i instanceof Uint8Array){if(i.length!==8)throw new Error(`cannot convert byte array stack item ${formatBitcoinStackItem(i)} to a int64, must be of length 8`);return new BigInt64Array(i.buffer)[0]}else throw typeof i>"u"||i===null?new Error("expected int64 stack item but found undefined/null"):new Error(`Unable to convert type ${typeof i} to an int64`)}}function convertStackItemToBitcoinScriptNumber(i){if(typeof i=="bigint")throw new Error(`cannot convert int64 stack item ${formatBitcoinStackItem(i)} to an int32, you must use OP_SCRIPTNUMTOLE64 to convert it`);if(typeof i=="number"){if(i>INT32_MAX$1||i<INT32_MIN$1)throw new Error(`cannot convert number stack item ${formatBitcoinStackItem(i)} to an int32, must be between ${INT32_MIN$1} and ${INT32_MAX$1}`);if(Math.floor(i)!==i||isNaN(i)||!isFinite(i))throw new Error(`cannot convert number stack item ${formatBitcoinStackItem(i)} to an int32, floats/doubles/infinity/NaN is not allowed}`);return i}else{if(typeof i=="string")throw new Error(`cannot convert string stack item ${formatBitcoinStackItem(i)} to an int32`);if(i instanceof Uint8Array){if(i.length>4)throw new Error(`cannot convert byte array stack item ${formatBitcoinStackItem(i)} to a int32, must be of length 4 or less`);return bytesToScriptNumber(i)}else throw typeof i>"u"||i===null?new Error("expected int32 stack item but found undefined/null"):new Error(`Unable to convert type ${typeof i} to an int32`)}}function convertStackItemToLEBytes(i){if(typeof i=="bigint")return bigIntToLEBytes(i);if(typeof i=="number")return scriptNumberToLEBytes(i);if(typeof i=="string")return new TextEncoder().encode(i);if(i instanceof Uint8Array)return i;throw typeof i>"u"||i===null?new Error("expected bytes stack item but found undefined/null"):new Error(`Unable to convert type ${typeof i} to bytes`)}function byteLengthForNumber(i){return i===0?0:i>0?Math.ceil((Math.log(i+1)/Math.log(2)+1)/8):Math.ceil((Math.log(-i)/Math.log(2)+1)/8+1)}function byteLengthForBigInt(i,e=!1){return i===0n?0:Math.ceil(e?i.toString(2).length/8+1:i.toString(2).length/8)}function isEqualStackItem(i,e){if(i===e)return!0;if(typeof i==typeof e&&(typeof i=="number"||typeof i=="boolean"||typeof i=="bigint"||typeof i=="string"))return i===e;const s=convertStackItemToLEBytes(i),N=convertStackItemToLEBytes(e);if(s.length!==N.length)return!1;for(let B=0;B<s.length;B++)if(s[B]!==N[B])return!1;return!0}function isStackItemFalsey(i){if(typeof i=="number")return i===0;if(typeof i=="bigint")return i===0n;if(i instanceof Uint8Array)return isZeroedArray(i);if(typeof i=="string")return i==="";throw new Error("invalid item type")}function isStackItemTruthy(i){return!isStackItemFalsey(i)}function serializeStackItem(i){if(typeof i=="number")return i;if(typeof i=="bigint")return{type:StackItemType.BigInt,value:i.toString()};if(i instanceof Uint8Array)return{type:StackItemType.ByteArray,value:u8ArrayToHex(i)};if(typeof i=="string")return i;throw new Error("Invalid stack item")}function serializeTaggedSnapshot(i){return{stack:i.stack.map(e=>({value:serializeStackItem(e.value),tag:e.tag,altTag:e.altTag})),altStack:i.altStack.map(e=>({value:serializeStackItem(e.value),tag:e.tag,altTag:e.altTag})),op:i.op}}function mainnetDisabledErrorMessage(i){return`${i} is disabled in bitcoin core`}const INT64_MAX=0x7fffffffffffffffn,INT64_MIN=-0x8000000000000000n,INT32_MAX=2147483647,INT32_MIN=-2147483647;class BitcoinComplexVMTraceBuilder{constructor(e,s=!0,N=!0,B,q){this.stack=[],this.altStack=[],this.ops=[],this.customOps=[],this.ifStack=[],this.shouldExecute=!0,this._shouldExecute=!0,this.executionEnabled=!0,this.disableExecutionAfterWitness=!1,this.indent="",this.tabString="  ",this.handlingCustomOpCode=0,this.endWitnessOpIndex=0,this.customOpCodeIfStackLength=0,this.tagPrefix="",this.customOpCodeId=0,this.customOpCodeIfStackLengthStack=[],this.customOpCodeIdStack=[],this.customOpCodeIdNameStack=[],this.currentCustomOpCode="",this.executionConfig=DEFAULT_BITCOIN_EXECUTION_CONFIG,this.executionEnabled=s,N?e.forEach(V=>this.constant(V)):this.stack=e.map(V=>({value:V})),this.recorder=B,q&&(this.executionConfig=q)}handleCheckSig(e,s){return this.executionConfig.sigCheckMode===BitcoinVMCheckSigMode.AlwaysSucceed?!0:this.executionConfig.sigCheckMode===BitcoinVMCheckSigMode.StandardWithOverride?isValidDummySignature(e,s):(console.error("full checksig for tx not implemented in interpreter mode"),!1)}getScriptHelpers(){return scriptHelpers}END_EXAMPLE_WITNESS(){if(this.ifStack.length!==0||this.handlingCustomOpCode!==0||this.customOpCodeIfStackLength!==0||this.customOpCodeIfStackLengthStack.length!==0)throw new Error("the witness cannot contain any custom op codes or conditional logic");if(this.altStack.length!==0)throw new Error("the witness section cannot push items to the alt stack");if(this.endWitnessOpIndex!==0||this.witnessStack)throw new Error("you may only use the END_EXAMPLE_WITNESS marker once per script");return this.witnessStack=this.stack.concat([]),this.endWitnessOpIndex=this.ops.length,this.disableExecutionAfterWitness&&(this.executionEnabled=!1),this}startCustomOpCode(e){this.currentCustomOpCode&&this.customOpCodeIdNameStack.push(this.currentCustomOpCode),this.currentCustomOpCode=e,this.handlingCustomOpCode++,this.customOpCodeIfStackLengthStack.push(this.customOpCodeIfStackLength),this.customOpCodeIfStackLength=this.ifStack.length,this.customOpCodeIdStack.push(this.customOpCodeId),this.customOpCodeId++,this.tagPrefix="~"+this.customOpCodeId+"_"}finishCustomOpCode(e){this.currentCustomOpCode=this.customOpCodeIdNameStack.pop()||"",this.handlingCustomOpCode--,this.handlingCustomOpCode===0&&this.customOps.push(e),this.customOpCodeIfStackLength=this.customOpCodeIfStackLengthStack.pop(),this.customOpCodeId=this.customOpCodeIdStack.pop(),this.customOpCodeId===0?this.tagPrefix="":this.tagPrefix="~"+this.customOpCodeId+"_",this.opFinished()}opFinished(){if(this.stack.length>1e3)throw new Error("Stack size exceeded 1000 values");this.recorder&&this.handlingCustomOpCode===0&&this.recorder(this)}addTest(e,s){}pushStack(e,s){this.stack.push({value:e,tag:s})}popStack(){return this.stack.pop().value}pushAltStack(e,s){this.altStack.push({value:e,tag:s})}popAltStack(){return this.altStack.pop().value}get shouldExecute1(){return this._shouldExecute&&this.executionEnabled}set shouldExecute1(e){this.executionEnabled&&(this._shouldExecute=e)}getStackSnapshot(){return{stack:this.stack.concat([]),altStack:this.altStack.concat([])}}emit(e,s=!1){this.ops.push(s?e:this.indent+e),this.handlingCustomOpCode===0&&this.customOps.push(s?e:this.indent+e)}safePopStackByteArray(){return convertStackItemToLEBytes(this.safePopStackAny())}safePopStackScriptNumber(){return convertStackItemToBitcoinScriptNumber(this.safePopStackAny())}safePopStackBooleanLike(){return isStackItemTruthy(this.safePopStackAny())}safePopStackInt64(){return convertStackItemToInt64(this.safePopStackAny())}safePeekStackAny(){const e=this.safePopStackAnyTagged();return this.pushStack(e.value,e.tag),e.value}safePeekStackBooleanLike(){const e=this.safePeekStackAny();return isStackItemTruthy(e)}safePopStackAny(){if(this.stack.length===0)throw new Error("Stack underflow");return this.popStack()}safePopStackAnyTagged(){if(this.stack.length===0)throw new Error("Stack underflow");return this.stack.pop()}safePopAltStackAny(){if(this.altStack.length===0)throw new Error("AltStack underflow");const e=this.altStack.pop();if(typeof e>"u")throw new Error("AltStack underflow");return e.value}safePopAltStackAnyTagged(){if(this.altStack.length===0)throw new Error("AltStack underflow");const e=this.altStack.pop();if(typeof e>"u")throw new Error("AltStack underflow");return e}safePopIfStack(){if(this.ifStack.length===0)throw new Error("IfStack underflow (unmatched OP_ENDIF)");return this.ifStack.pop()}safePeekIfStack(){if(this.ifStack.length===0)throw new Error("empty ifStack (unmatched ELSE)");return this.ifStack[this.ifStack.length-1]}comment(e,s=0){s?this.emit(generateIndent(this.ifStack.length-s,this.tabString)+"// "+e,!0):this.emit("// "+e)}hexBytes(e){const s=hexToU8Array(e);return this.constant(s)}constant(e,s=!1){if(typeof e=="number"){if(e>=0&&e<=16)return this.emit("OP_"+e),this.shouldExecute&&(this.pushStack(e),this.opFinished()),this}else if(!s&&typeof e=="bigint"&&e>=0n&&e<=16n)return this.emit("OP_"+e),this.shouldExecute&&(this.pushStack(Number(e)),this.opFinished()),this;return this.emit(formatBitcoinStackItem(e)),this.shouldExecute&&(this.pushStack(e),this.opFinished()),this}constantLimbs(e,s,N,B){const q=decomposeLimbs(e,s,N).reverse();return q.forEach((V,Y)=>{this.constant(V),B&&this.tag(B+(q.length-Y-1))}),this}uconstant(e){const s=new BigInt64Array(new BigUint64Array([e]).buffer)[0];return this.constant(s)}i64(e){if(Array.isArray(e))return e.forEach(N=>this.i64(N)),this;const s=bigIntToLEBytes(BigInt(e));return this.emit(formatBitcoinStackItem(s)),this.shouldExecute&&(this.pushStack(BigInt(e)),this.opFinished()),this}constants(e,s=!1){return e.forEach(N=>this.constant(N,s)),this}rawConstants(e){return e.forEach(s=>this.constant(s,!0)),this}uconstants(e){return e.forEach(s=>this.uconstant(s)),this}OP_IF(){return this.emit("OP_IF"),this.ifStack.push(this.shouldExecute),this.indent=generateIndent(this.ifStack.length,this.tabString),this.shouldExecute&&(this.shouldExecute=this.safePopStackBooleanLike()&&this.executionEnabled),this.executionEnabled&&this.opFinished(),this}OP_ELSE(){return this.emit(generateIndent(this.ifStack.length-1,this.tabString)+"OP_ELSE",!0),this.shouldExecute=this.safePeekIfStack()&&!this.shouldExecute&&this.executionEnabled,this.executionEnabled&&this.opFinished(),this}OP_ENDIF(){return this.shouldExecute=this.safePopIfStack()&&this.executionEnabled,this.emit("OP_ENDIF"),this.executionEnabled&&this.opFinished(),this}ifElse(e,s){return this.safePeekStackBooleanLike(),this.getStackSnapshot(),this.OP_IF(),this.getStackSnapshot(),e(),this.OP_ELSE(),this.getStackSnapshot(),s(),this.OP_ENDIF(),this.getStackSnapshot(),this}OP_NOTIF(){return this.emit("OP_NOTIF"),this.ifStack.push(this.shouldExecute),this.indent=generateIndent(this.ifStack.length,this.tabString),this.shouldExecute=this.shouldExecute&&!this.safePopStackBooleanLike()&&this.executionEnabled,this.executionEnabled&&this.opFinished(),this}OP_VERIFY(){if(this.emit("OP_VERIFY"),this.shouldExecute){if(!this.safePopStackBooleanLike()&&this.executionEnabled)throw new Error("OP_VERIFY failed");this.opFinished()}return this}OP_RETURN(){return this.emit("OP_RETURN"),this.shouldExecute&&this.executionEnabled&&(this.executionEnabled=!1,this.shouldExecute=!1,this.opFinished()),this}OP_TOALTSTACK(){return this.emit("OP_TOALTSTACK"),this.shouldExecute&&(this.altStack.push(this.safePopStackAnyTagged()),this.opFinished()),this}OP_FROMALTSTACK(){return this.emit("OP_FROMALTSTACK"),this.shouldExecute&&(this.stack.push(this.safePopAltStackAnyTagged()),this.opFinished()),this}OP_2DROP(){return this.emit("OP_2DROP"),this.shouldExecute&&(this.safePopStackAny(),this.safePopStackAny(),this.opFinished()),this}OP_2DUP(){if(this.emit("OP_2DUP"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged();this.stack.push(s),this.stack.push(e),this.stack.push({...s}),this.stack.push({...e}),this.opFinished()}return this}OP_3DUP(){if(this.emit("OP_3DUP"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged(),N=this.safePopStackAnyTagged();this.stack.push(N),this.stack.push(s),this.stack.push(e),this.stack.push({...N}),this.stack.push({...s}),this.stack.push({...e}),this.opFinished()}return this}OP_2OVER(){if(this.emit("OP_2OVER"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged(),N=this.safePopStackAnyTagged(),B=this.safePopStackAnyTagged();this.stack.push(B),this.stack.push(N),this.stack.push(s),this.stack.push(e),this.stack.push({...B}),this.stack.push({...N}),this.opFinished()}return this}OP_2ROT(){if(this.emit("OP_2ROT"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged(),N=this.safePopStackAnyTagged(),B=this.safePopStackAnyTagged(),q=this.safePopStackAnyTagged(),V=this.safePopStackAnyTagged();this.stack.push(B),this.stack.push(N),this.stack.push(s),this.stack.push(e),this.stack.push(V),this.stack.push(q),this.opFinished()}return this}OP_2SWAP(){if(this.emit("OP_2SWAP"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged(),N=this.safePopStackAnyTagged(),B=this.safePopStackAnyTagged();this.stack.push(s),this.stack.push(e),this.stack.push(B),this.stack.push(N),this.opFinished()}return this}OP_IFDUP(){if(this.emit("OP_IFDUP"),this.shouldExecute){const e=this.safePopStackAnyTagged();e.value!==0&&(this.stack.push(e),this.stack.push({...e})),this.opFinished()}return this}OP_DEPTH(){return this.emit("OP_DEPTH"),this.shouldExecute&&(this.pushStack(this.stack.length),this.opFinished()),this}OP_DROP(){return this.emit("OP_DROP"),this.shouldExecute&&(this.safePopStackAny(),this.opFinished()),this}OP_DUP(){if(this.emit("OP_DUP"),this.shouldExecute){const e=this.safePopStackAnyTagged();this.stack.push(e),this.stack.push({...e}),this.opFinished()}return this}OP_NIP(){if(this.emit("OP_NIP"),this.shouldExecute){const e=this.safePopStackAnyTagged();this.safePopStackAny(),this.stack.push(e),this.opFinished()}return this}OP_OVER(){if(this.emit("OP_OVER"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged();this.stack.push(s),this.stack.push(e),this.stack.push({...s}),this.opFinished()}return this}pick(e){return this.constant(e),this.OP_PICK(),this}roll(e){return this.constant(e),this.OP_ROLL(),this}OP_PICK(){if(this.emit("OP_PICK"),this.shouldExecute){const e=this.safePopStackScriptNumber();if(e<0||e>=this.stack.length)throw new Error("OP_PICK failed");this.stack.push({...this.stack[this.stack.length-1-e]}),this.opFinished()}return this}OP_ROLL(){if(this.emit("OP_ROLL"),this.shouldExecute){const e=this.safePopStackScriptNumber();if(e<0||e>=this.stack.length)throw new Error("OP_ROLL failed");this.stack.push(this.stack.splice(this.stack.length-1-e,1)[0]),this.opFinished()}return this}OP_ROT(){if(this.emit("OP_ROT"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged(),N=this.safePopStackAnyTagged();this.stack.push(s),this.stack.push(e),this.stack.push(N),this.opFinished()}return this}OP_SWAP(){if(this.emit("OP_SWAP"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged();this.stack.push(e),this.stack.push(s),this.opFinished()}return this}OP_TUCK(){if(this.emit("OP_TUCK"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged();this.stack.push({...e}),this.stack.push(s),this.stack.push(e),this.opFinished()}return this}OP_SIZE(){if(this.emit("OP_SIZE"),this.shouldExecute){const e=this.safePopStackAnyTagged();this.stack.push(e);const s=e.value;if(typeof s=="number"){const N=byteLengthForNumber(s);this.pushStack(N)}else if(typeof s=="bigint"){const N=byteLengthForBigInt(s);this.pushStack(N)}else this.pushStack(convertStackItemToLEBytes(s).length);this.opFinished()}return this}OP_EQUAL(){if(this.emit("OP_EQUAL"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged();this.pushStack(isEqualStackItem(e.value,s.value)?1:0),this.opFinished()}return this}OP_EQUALVERIFY(){if(this.emit("OP_EQUALVERIFY"),this.shouldExecute){const e=this.safePopStackAny(),s=this.safePopStackAny();if(this.executionEnabled&&!isEqualStackItem(e,s))throw new Error("OP_EQUALVERIFY failed");this.opFinished()}return this}OP_1ADD(){if(this.emit("OP_1ADD"),this.shouldExecute){const e=this.safePopStackScriptNumber();this.pushStack(e+1),this.opFinished()}return this}OP_1SUB(){if(this.emit("OP_1SUB"),this.shouldExecute){const e=this.safePopStackScriptNumber();this.pushStack(e-1),this.opFinished()}return this}OP_NEGATE(){if(this.emit("OP_NEGATE"),this.shouldExecute){const e=this.safePopStackScriptNumber();this.pushStack(e===0?0:-e),this.opFinished()}return this}OP_ABS(){if(this.emit("OP_ABS"),this.shouldExecute){const e=this.safePopStackScriptNumber();this.pushStack(Math.abs(e)),this.opFinished()}return this}OP_NOT(){if(this.emit("OP_NOT"),this.shouldExecute){const e=this.safePopStackScriptNumber();this.pushStack(e===0?1:0),this.opFinished()}return this}OP_0NOTEQUAL(){if(this.emit("OP_0NOTEQUAL"),this.shouldExecute){const e=this.safePopStackScriptNumber();this.pushStack(e===0?0:1),this.opFinished()}return this}OP_ADD(){if(this.emit("OP_ADD"),this.shouldExecute){const e=this.safePopStackScriptNumber(),s=this.safePopStackScriptNumber();this.pushStack(e+s),this.opFinished()}return this}OP_SUB(){if(this.emit("OP_SUB"),this.shouldExecute){const e=this.safePopStackScriptNumber(),s=this.safePopStackScriptNumber();this.pushStack(s-e),this.opFinished()}return this}OP_BOOLAND(){if(this.emit("OP_BOOLAND"),this.shouldExecute){const e=this.safePopStackScriptNumber(),s=this.safePopStackScriptNumber();this.pushStack(e!==0&&s!==0?1:0),this.opFinished()}return this}OP_BOOLOR(){if(this.emit("OP_BOOLOR"),this.shouldExecute){const e=this.safePopStackScriptNumber(),s=this.safePopStackScriptNumber();this.pushStack(e!==0||s!==0?1:0),this.opFinished()}return this}OP_NUMEQUAL(){if(this.emit("OP_NUMEQUAL"),this.shouldExecute){const e=this.safePopStackScriptNumber(),s=this.safePopStackScriptNumber();this.pushStack(e===s?1:0),this.opFinished()}return this}OP_NUMEQUALVERIFY(){if(this.emit("OP_NUMEQUALVERIFY"),this.shouldExecute){const e=this.safePopStackScriptNumber(),s=this.safePopStackScriptNumber();if(e!==s&&this.executionEnabled)throw new Error("OP_NUMEQUALVERIFY failed");this.opFinished()}return this}OP_NUMNOTEQUAL(){if(this.emit("OP_NUMNOTEQUAL"),this.shouldExecute){const e=this.safePopStackScriptNumber(),s=this.safePopStackScriptNumber();this.pushStack(e!==s?1:0),this.opFinished()}return this}OP_LESSTHAN(){if(this.emit("OP_LESSTHAN"),this.shouldExecute){const e=this.safePopStackScriptNumber(),s=this.safePopStackScriptNumber();this.pushStack(s<e?1:0),this.opFinished()}return this}OP_GREATERTHAN(){if(this.emit("OP_GREATERTHAN"),this.shouldExecute){const e=this.safePopStackScriptNumber(),s=this.safePopStackScriptNumber();this.pushStack(s>e?1:0),this.opFinished()}return this}OP_LESSTHANOREQUAL(){if(this.emit("OP_LESSTHANOREQUAL"),this.shouldExecute){const e=this.safePopStackScriptNumber(),s=this.safePopStackScriptNumber();this.pushStack(s<=e?1:0),this.opFinished()}return this}OP_HASH256(){if(this.emit("OP_HASH256"),this.shouldExecute){const e=this.safePopStackByteArray();this.pushStack(createHash("sha256").update(createHash("sha256").update(e).digest()).digest()),this.opFinished()}return this}OP_HASH160(){if(this.emit("OP_HASH160"),this.shouldExecute){const e=this.safePopStackByteArray();this.pushStack(ripemd160(createHash("sha256").update(e).digest())),this.opFinished()}return this}OP_RIPEMD160(){if(this.emit("OP_RIPEMD160"),this.shouldExecute){const e=this.safePopStackByteArray();this.pushStack(ripemd160(e)),this.opFinished()}return this}OP_SHA256(){if(this.emit("OP_SHA256"),this.shouldExecute){const e=this.safePopStackByteArray();this.pushStack(createHash("sha256").update(e).digest()),this.opFinished()}return this}OP_CHECKSIG(){if(this.emit("OP_CHECKSIG"),this.shouldExecute){const e=this.safePopStackByteArray(),s=this.safePopStackByteArray();this.pushStack(this.handleCheckSig(e,s)?1:0),this.opFinished()}return this}OP_CHECKSIGVERIFY(){if(this.emit("OP_CHECKSIGVERIFY"),this.shouldExecute){const e=this.safePopStackByteArray(),s=this.safePopStackByteArray();if(this.executionEnabled&&!this.handleCheckSig(e,s))throw new Error("OP_CHECKSIGVERIFY failed");this.opFinished()}return this}OP_GREATERTHANOREQUAL(){if(this.emit("OP_GREATERTHANOREQUAL"),this.shouldExecute){const e=this.safePopStackScriptNumber(),s=this.safePopStackScriptNumber();this.pushStack(s>=e?1:0),this.opFinished()}return this}OP_MIN(){if(this.emit("OP_MIN"),this.shouldExecute){const e=this.safePopStackScriptNumber(),s=this.safePopStackScriptNumber();this.pushStack(Math.min(e,s)),this.opFinished()}return this}OP_MAX(){if(this.emit("OP_MAX"),this.shouldExecute){const e=this.safePopStackScriptNumber(),s=this.safePopStackScriptNumber();this.pushStack(Math.max(e,s)),this.opFinished()}return this}OP_WITHIN(){if(this.emit("OP_WITHIN"),this.shouldExecute){const e=this.safePopStackScriptNumber(),s=this.safePopStackScriptNumber(),N=this.safePopStackScriptNumber();this.pushStack(N>=s&&N<e?1:0),this.opFinished()}return this}OP_0(){return this.emit("OP_0"),this.shouldExecute&&(this.pushStack(0),this.opFinished()),this}OP_1(){return this.emit("OP_1"),this.shouldExecute&&(this.pushStack(1),this.opFinished()),this}OP_2(){return this.emit("OP_2"),this.shouldExecute&&(this.pushStack(2),this.opFinished()),this}OP_3(){return this.emit("OP_3"),this.shouldExecute&&(this.pushStack(3),this.opFinished()),this}OP_4(){return this.emit("OP_4"),this.shouldExecute&&(this.pushStack(4),this.opFinished()),this}OP_5(){return this.emit("OP_5"),this.shouldExecute&&(this.pushStack(5),this.opFinished()),this}OP_6(){return this.emit("OP_6"),this.shouldExecute&&(this.pushStack(6),this.opFinished()),this}OP_7(){return this.emit("OP_7"),this.shouldExecute&&(this.pushStack(7),this.opFinished()),this}OP_8(){return this.emit("OP_8"),this.shouldExecute&&(this.pushStack(8),this.opFinished()),this}OP_9(){return this.emit("OP_9"),this.shouldExecute&&(this.pushStack(9),this.opFinished()),this}OP_10(){return this.emit("OP_10"),this.shouldExecute&&(this.pushStack(10),this.opFinished()),this}OP_11(){return this.emit("OP_11"),this.shouldExecute&&(this.pushStack(11),this.opFinished()),this}OP_12(){return this.emit("OP_12"),this.shouldExecute&&(this.pushStack(12),this.opFinished()),this}OP_13(){return this.emit("OP_13"),this.shouldExecute&&(this.pushStack(13),this.opFinished()),this}OP_14(){return this.emit("OP_14"),this.shouldExecute&&(this.pushStack(14),this.opFinished()),this}OP_15(){return this.emit("OP_15"),this.shouldExecute&&(this.pushStack(15),this.opFinished()),this}OP_16(){return this.emit("OP_16"),this.shouldExecute&&(this.pushStack(16),this.opFinished()),this}OP_NOP(){return this.emit("OP_NOP"),this.opFinished(),this}OP_CHECKGROTH16VERIFY(){if(this.emit("OP_CHECKGROTH16VERIFY"),this.shouldExecute){if(this.stack.length<12)throw new Error("OP_CHECKGROTH16VERIFY requires at least 12 items on the stack");const e=this.safePeekStackAny();if(typeof e!="number")throw new Error("OP_CHECKGROTH16VERIFY requires a number as the first argument");if(e!==0&&e!==1)throw new Error("OP_CHECKGROTH16VERIFY requires the first argument to be 0 or 1");if(e===0&&this.stack.length<13)throw new Error("OP_CHECKGROTH16VERIFY requires at least 13 items on the stack when mode is 0");this.opFinished()}return this}liquidOpsEnabled(){return this.executionConfig.vmMode==="liquid"}mainnetDisabledOpsEnabled(){return!0}OP_MUL64(){if(!this.liquidOpsEnabled())throw new Error("OP_MUL64 is only available in liquid mode");if(this.emit("OP_MUL64"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged();this.stack.push(e),this.stack.push(s);const N=this.safePopStackInt64(),B=this.safePopStackInt64();if(N>0n&&B>0n&&N>INT64_MAX/B||N>0n&&B<0n&&B<INT64_MIN/N||N<0n&&B>0n&&N<INT64_MIN/B||N<0n&&B<0n&&B<INT64_MAX/N)this.stack.push(e),this.stack.push(s),this.pushStack(0);else{const q=N*B;this.pushStack(q),this.pushStack(1)}this.opFinished()}return this}OP_DIV64(){if(!this.liquidOpsEnabled())throw new Error("OP_DIV64 is only available in liquid mode");if(this.emit("OP_DIV64"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged();this.stack.push(s),this.stack.push(e);const N=this.safePopStackInt64(),B=this.safePopStackInt64();if(N==0n||N==-1n&&B==INT64_MIN)this.stack.push(s),this.stack.push(e),this.pushStack(0);else{let q=B%N,V=B/N;q<0n&&N>0n?(q+=N,V-=1n):q<0n&&N<0n&&(q-=N,V+=1n),this.pushStack(q),this.pushStack(V),this.pushStack(1)}this.opFinished()}return this}OP_ADD64(){if(!this.liquidOpsEnabled())throw new Error("OP_ADD64 is only available in liquid mode");if(this.emit("OP_ADD64"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged();this.stack.push(s),this.stack.push(e);const N=this.safePopStackInt64(),B=this.safePopStackInt64();if(B>0n&&N>INT64_MAX-B||B<0n&&N<INT64_MIN-B)this.stack.push(s),this.stack.push(e),this.pushStack(0);else{const q=B+N;this.pushStack(q),this.pushStack(1)}this.opFinished()}return this}OP_SUB64(){if(!this.liquidOpsEnabled())throw new Error("OP_SUB64 is only available in liquid mode");if(this.emit("OP_SUB64"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged();this.stack.push(s),this.stack.push(e);const N=this.safePopStackInt64(),B=this.safePopStackInt64();if(N>0n&&B<INT64_MIN+N||N<0n&&B>INT64_MAX+N)this.stack.push(s),this.stack.push(e),this.pushStack(0);else{const q=B-N;this.pushStack(q),this.pushStack(1)}this.opFinished()}return this}OP_NEG64(){if(!this.liquidOpsEnabled())throw new Error("OP_NEG64 is only available in liquid mode");if(this.emit("OP_NEG64"),this.shouldExecute){const e=this.safePopStackAnyTagged();this.stack.push(e);const s=this.safePopStackInt64();if(s===INT64_MIN)this.stack.push(e),this.pushStack(0);else{const N=-s;this.pushStack(N),this.pushStack(1)}this.opFinished()}return this}OP_LESSTHAN64(){if(!this.liquidOpsEnabled())throw new Error("OP_LESSTHAN64 is only available in liquid mode");if(this.emit("OP_LESSTHAN64"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged();this.stack.push(s),this.stack.push(e);const N=this.safePopStackInt64(),B=this.safePopStackInt64();this.pushStack(B<N?1:0),this.opFinished()}return this}OP_LESSTHANOREQUAL64(){if(!this.liquidOpsEnabled())throw new Error("OP_LESSTHANOREQUAL64 is only available in liquid mode");if(this.emit("OP_LESSTHANOREQUAL64"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged();this.stack.push(s),this.stack.push(e);const N=this.safePopStackInt64(),B=this.safePopStackInt64();this.pushStack(B<=N?1:0),this.opFinished()}return this}OP_GREATERTHAN64(){if(!this.liquidOpsEnabled())throw new Error("OP_GREATERTHAN64 is only available in liquid mode");if(this.emit("OP_GREATERTHAN64"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged();this.stack.push(s),this.stack.push(e);const N=this.safePopStackInt64(),B=this.safePopStackInt64();this.pushStack(B>N?1:0),this.opFinished()}return this}OP_GREATERTHANOREQUAL64(){if(!this.liquidOpsEnabled())throw new Error("OP_GREATERTHANOREQUAL64 is only available in liquid mode");if(this.emit("OP_GREATERTHANOREQUAL64"),this.shouldExecute){const e=this.safePopStackAnyTagged(),s=this.safePopStackAnyTagged();this.stack.push(s),this.stack.push(e);const N=this.safePopStackInt64(),B=this.safePopStackInt64();this.pushStack(B>N?1:0),this.opFinished()}return this}OP_SCRIPTNUMTOLE64(){if(!this.liquidOpsEnabled())throw new Error("OP_SCRIPTNUMTOLE64 is only available in liquid mode");if(this.emit("OP_SCRIPTNUMTOLE64"),this.shouldExecute){const e=this.safePopStackScriptNumber();this.pushStack(BigInt(Math.max(INT32_MIN,Math.min(e,INT32_MAX)))),this.opFinished()}return this}OP_LE64TOSCRIPTNUM(){if(!this.liquidOpsEnabled())throw new Error("OP_LE64TOSCRIPTNUM is only available in liquid mode");if(this.emit("OP_LE64TOSCRIPTNUM"),this.shouldExecute){const e=this.safePopStackInt64();if(e>BigInt(INT32_MAX)||e<BigInt(INT32_MIN))throw new Error("OP_LE64TOSCRIPTNUM: input must be between INT32_MIN and INT32_MAX");this.pushStack(Number(e)),this.opFinished()}return this}OP_LE32TOLE64(){if(!this.liquidOpsEnabled())throw new Error("OP_LE64TOSCRIPTNUM is only available in liquid mode");if(this.emit("OP_LE32TOLE64"),this.shouldExecute){const e=this.safePopStackByteArray();if(e.length!==4)throw new Error("OP_LE32TOLE64: input must be 4 bytes");this.pushStack(BigInt(new Uint32Array(e.buffer)[0])),this.opFinished()}}OP_CAT(){if(!this.mainnetDisabledOpsEnabled())throw new Error(mainnetDisabledErrorMessage("OP_CAT"));if(this.emit("OP_CAT"),this.shouldExecute){const e=this.safePopStackByteArray(),s=this.safePopStackByteArray();this.pushStack(new Uint8Array(Array.from(s).concat(Array.from(e)))),this.opFinished()}return this}OP_OR(){if(!this.mainnetDisabledOpsEnabled())throw new Error(mainnetDisabledErrorMessage("OP_OR"));if(this.emit("OP_OR"),this.shouldExecute){let e=this.safePopStackByteArray(),s=this.safePopStackByteArray();if(e.length!==s.length)throw new Error("OP_OR requires equal length inputs");if(e.length<s.length){const q=e;e=s,s=q}const N=new Uint8Array(Array.from(e)),B=Math.min(e.length,s.length);for(let q=0;q<B;q++)N[q]|=s[q];this.pushStack(N),this.opFinished()}return this}OP_AND(){if(!this.mainnetDisabledOpsEnabled())throw new Error(mainnetDisabledErrorMessage("OP_AND"));if(this.emit("OP_AND"),this.shouldExecute){let e=this.safePopStackByteArray(),s=this.safePopStackByteArray();if(e.length!==s.length)throw new Error("OP_AND requires equal length inputs");if(e.length<s.length){const q=e;e=s,s=q}const N=new Uint8Array(Array.from(e)),B=Math.min(e.length,s.length);for(let q=0;q<B;q++)N[q]&=s[q];this.pushStack(N),this.opFinished()}return this}OP_XOR(){if(!this.mainnetDisabledOpsEnabled())throw new Error(mainnetDisabledErrorMessage("OP_XOR"));if(this.emit("OP_XOR"),this.shouldExecute){let e=this.safePopStackByteArray(),s=this.safePopStackByteArray();if(e.length!==s.length)throw new Error("OP_XOR requires equal length inputs");if(e.length<s.length){const q=e;e=s,s=q}const N=new Uint8Array(Array.from(e)),B=Math.min(e.length,s.length);for(let q=0;q<B;q++)N[q]^=s[q];this.pushStack(N),this.opFinished()}return this}getBitcoinScript(){return this.ops.join(`
`)}getBitcoinScriptAndWitness(){return!this.witnessStack||this.endWitnessOpIndex===0?{ops:this.ops.concat([]),witnessStack:[]}:{ops:this.ops.slice(this.endWitnessOpIndex),witnessStack:this.witnessStack.concat([])}}getInstanceWithCustomOpCodes(e){const s={get(B,q,V){if(typeof q=="string"){if(Object.hasOwnProperty.call(e,q))return e[q].bind(N,N);if(Object.hasOwnProperty.call(B,q)){const Y=Reflect.get(...arguments);if(typeof Y=="function")return Y.bind(N)}}return Reflect.get(...arguments)}},N=new Proxy(this,s);return N}tag(e,s=0){if(this.shouldExecute){typeof e=="string"&&(e=[e]);for(let N=0;N<e.length;N++)this.stack[this.stack.length-1-N-s].tag=this.tagPrefix+e[N]}return this}selectTagIndex(e){if(this.ifStack.length===0){for(let s=0;s<this.stack.length;s++)if(this.stack[this.stack.length-s-1].tag===this.tagPrefix+e)return this.constant(s),this;throw new Error("tag not found: "+e)}else throw new Error("you cannot use pickTag inside an if/else statement")}createGroup(e,s){const N=(B,q)=>e+"__"+B+"_"+q;return this.generateGroupSelector(N,s)}generateGroupSelector(e,s){const N=this;function B(Z){for(let et=s-1;et>=0;et--)N.pickTag(e(Z,et))}function q(Z){for(let et=s-1;et>=0;et--)N.rollTag(e(Z,et))}function V(Z){let et=0;const ot=2*Math.floor(s/2);for(;et<ot;et+=2)N.rollTag(e(Z,et)),N.rollTag(e(Z,et+1)),N.OP_2DROP();et<s&&(N.rollTag(e(Z,et)),N.OP_DROP())}function Y(Z,et=0){const ot=[];for(let pt=0;pt<s;pt++)ot.push(e(Z,pt));N.tag(ot)}function it(Z,et){for(let ot=0;ot<s;ot++)N.replaceTag(e(Z,ot),e(et,ot))}return{pick:B,roll:q,drop:V,setTag:Y,renameTag:it,tag:e}}pickOptInternal(e){e===0?this.OP_DUP():e===1?this.OP_OVER():(this.constant(e),this.OP_PICK())}rollOptInternal(e){e===0||(e===1?this.OP_SWAP():e===2?this.OP_ROT():(this.constant(e),this.OP_ROLL()))}replaceTag(e,s){if(this.ifStack.length===0){for(let N=0;N<this.stack.length;N++)if(this.stack[this.stack.length-N-1].tag===this.tagPrefix+e)return this.stack[this.stack.length-N-1].tag=this.tagPrefix+s,this;return this}else throw new Error("you cannot use replaceTag inside an if/else statement")}pickTagSingle(e){if(this.ifStack.length===0){for(let s=0;s<this.stack.length;s++)if(this.stack[this.stack.length-s-1].tag===this.tagPrefix+e)return this.pickOptInternal(s),this;throw new Error("tag not found: "+e)}else throw new Error("you cannot use pickTag inside an if/else statement")}getTagPointer(e){if(this.ifStack.length===0){for(let s=0;s<this.stack.length;s++)if(this.stack[this.stack.length-s-1].tag===this.tagPrefix+e)return this.stack.length-s-1;throw new Error("tag not found: "+e)}else throw new Error("you cannot use getTagPointer inside an if/else statement")}getTagsInContext(e){const s=[],N=this.tagPrefix+e,B=N.length,q={};if(this.ifStack.length===0){for(let V=0;V<this.stack.length;V++){const Y=this.stack[this.stack.length-V-1].tag;Y&&Y.substring(0,B)===N&&!q[Y]&&(q[Y]=!0,s.push({id:Y.substring(this.tagPrefix.length),suffix:Y.substring(B),stackIndex:V}))}return s}else throw new Error("you cannot use getTagsInContext inside an if/else statement")}pickGroup(e){if(this.ifStack.length!==0)throw new Error("you cannot use pickGroup inside an if/else statement");return this.getTagsInContext(e+"__").filter(s=>s.suffix.trim().length&&!/[^0-9]/.test(s.suffix)).map(s=>({id:s.id,stackIndex:s.stackIndex,index:parseInt(s.suffix)})).sort((s,N)=>N.index-s.index).forEach(s=>{this.pickTag(s.id)}),this}rollGroup(e){if(this.ifStack.length!==0)throw new Error("you cannot use rollGroup inside an if/else statement");return this.getTagsInContext(e+"__").filter(s=>s.suffix.trim().length&&!/[^0-9]/.test(s.suffix)).map(s=>({id:s.id,stackIndex:s.stackIndex,index:parseInt(s.suffix)})).sort((s,N)=>N.index-s.index).forEach(s=>{this.pickTag(s.id)}),this}tagGroup(e,s){if(typeof s!="number"||s<1)throw new Error("missing count in tagGroup!");const N=[];for(let B=0;B<s;B++)N.push(e+"__"+B);return this.tag(N),this}rollTagSingle(e){if(this.ifStack.length===0){for(let s=0;s<this.stack.length;s++)if(this.stack[this.stack.length-s-1].tag===this.tagPrefix+e)return this.rollOptInternal(s),this;throw new Error("tag not found: "+e)}else throw new Error("you cannot use pickTag inside an if/else statement")}pickTag(e){return typeof e=="string"?this.pickTagSingle(e):(e.forEach(s=>this.pickTagSingle(s)),this)}rollTag(e){return typeof e=="string"?this.rollTagSingle(e):(e.forEach(s=>this.rollTagSingle(s)),this)}verifyEqualStackItems(e){if(e.length){for(let s=e.length-1;s>0;s--)this.rawConstants([e[s]]),this.OP_EQUALVERIFY();this.rawConstants([e[0]]),this.OP_EQUAL()}}}var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var moo$1={exports:{}};(function(i){(function(e,s){i.exports?i.exports=s():e.moo=s()})(commonjsGlobal,function(){var e=Object.prototype.hasOwnProperty,s=Object.prototype.toString,N=typeof new RegExp().sticky=="boolean";function B(G){return G&&s.call(G)==="[object RegExp]"}function q(G){return G&&typeof G=="object"&&!B(G)&&!Array.isArray(G)}function V(G){return G.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function Y(G){var Q=new RegExp("|"+G);return Q.exec("").length-1}function it(G){return"("+G+")"}function Z(G){if(!G.length)return"(?!)";var Q=G.map(function(X){return"(?:"+X+")"}).join("|");return"(?:"+Q+")"}function et(G){if(typeof G=="string")return"(?:"+V(G)+")";if(B(G)){if(G.ignoreCase)throw new Error("RegExp /i flag not allowed");if(G.global)throw new Error("RegExp /g flag is implied");if(G.sticky)throw new Error("RegExp /y flag is implied");if(G.multiline)throw new Error("RegExp /m flag is implied");return G.source}else throw new Error("Not a pattern: "+G)}function ot(G,Q){return G.length>Q?G:Array(Q-G.length+1).join(" ")+G}function pt(G,Q){for(var X=G.length,J=0;;){var nt=G.lastIndexOf(`
`,X-1);if(nt===-1||(J++,X=nt,J===Q)||X===0)break}var tt=J<Q?0:X+1;return G.substring(tt).split(`
`)}function ct(G){for(var Q=Object.getOwnPropertyNames(G),X=[],J=0;J<Q.length;J++){var nt=Q[J],tt=G[nt],rt=[].concat(tt);if(nt==="include"){for(var ht=0;ht<rt.length;ht++)X.push({include:rt[ht]});continue}var at=[];rt.forEach(function(st){q(st)?(at.length&&X.push(mt(nt,at)),X.push(mt(nt,st)),at=[]):at.push(st)}),at.length&&X.push(mt(nt,at))}return X}function _t(G){for(var Q=[],X=0;X<G.length;X++){var J=G[X];if(J.include){for(var nt=[].concat(J.include),tt=0;tt<nt.length;tt++)Q.push({include:nt[tt]});continue}if(!J.type)throw new Error("Rule has no type: "+JSON.stringify(J));Q.push(mt(J.type,J))}return Q}function mt(G,Q){if(q(Q)||(Q={match:Q}),Q.include)throw new Error("Matching rules cannot also include states");var X={defaultType:G,lineBreaks:!!Q.error||!!Q.fallback,pop:!1,next:null,push:null,error:!1,fallback:!1,value:null,type:null,shouldThrow:!1};for(var J in Q)e.call(Q,J)&&(X[J]=Q[J]);if(typeof X.type=="string"&&G!==X.type)throw new Error("Type transform cannot be a string (type '"+X.type+"' for token '"+G+"')");var nt=X.match;return X.match=Array.isArray(nt)?nt:nt?[nt]:[],X.match.sort(function(tt,rt){return B(tt)&&B(rt)?0:B(rt)?-1:B(tt)?1:rt.length-tt.length}),X}function kt(G){return Array.isArray(G)?_t(G):ct(G)}var dt=mt("error",{lineBreaks:!0,shouldThrow:!0});function gt(G,Q){for(var X=null,J=Object.create(null),nt=!0,tt=null,rt=[],ht=[],at=0;at<G.length;at++)G[at].fallback&&(nt=!1);for(var at=0;at<G.length;at++){var st=G[at];if(st.include)throw new Error("Inheritance is not allowed in stateless lexers");if(st.error||st.fallback){if(X)throw!st.fallback==!X.fallback?new Error("Multiple "+(st.fallback?"fallback":"error")+" rules not allowed (for token '"+st.defaultType+"')"):new Error("fallback and error are mutually exclusive (for token '"+st.defaultType+"')");X=st}var ut=st.match.slice();if(nt)for(;ut.length&&typeof ut[0]=="string"&&ut[0].length===1;){var Et=ut.shift();J[Et.charCodeAt(0)]=st}if(st.pop||st.push||st.next){if(!Q)throw new Error("State-switching options are not allowed in stateless lexers (for token '"+st.defaultType+"')");if(st.fallback)throw new Error("State-switching options are not allowed on fallback tokens (for token '"+st.defaultType+"')")}if(ut.length!==0){nt=!1,rt.push(st);for(var yt=0;yt<ut.length;yt++){var St=ut[yt];if(B(St)){if(tt===null)tt=St.unicode;else if(tt!==St.unicode&&st.fallback===!1)throw new Error("If one rule is /u then all must be")}}var Ot=Z(ut.map(et)),ft=new RegExp(Ot);if(ft.test(""))throw new Error("RegExp matches empty string: "+ft);var bt=Y(Ot);if(bt>0)throw new Error("RegExp has capture groups: "+ft+`
Use (?: … ) instead`);if(!st.lineBreaks&&ft.test(`
`))throw new Error("Rule should declare lineBreaks: "+ft);ht.push(it(Ot))}}var Pt=X&&X.fallback,Tt=N&&!Pt?"ym":"gm",At=N||Pt?"":"|";tt===!0&&(Tt+="u");var Mt=new RegExp(Z(ht)+At,Tt);return{regexp:Mt,groups:rt,fast:J,error:X||dt}}function wt(G){var Q=gt(kt(G));return new lt({start:Q},"start")}function xt(G,Q,X){var J=G&&(G.push||G.next);if(J&&!X[J])throw new Error("Missing state '"+J+"' (in token '"+G.defaultType+"' of state '"+Q+"')");if(G&&G.pop&&+G.pop!=1)throw new Error("pop must be 1 (in token '"+G.defaultType+"' of state '"+Q+"')")}function Nt(G,Q){var X=G.$all?kt(G.$all):[];delete G.$all;var J=Object.getOwnPropertyNames(G);Q||(Q=J[0]);for(var nt=Object.create(null),tt=0;tt<J.length;tt++){var rt=J[tt];nt[rt]=kt(G[rt]).concat(X)}for(var tt=0;tt<J.length;tt++)for(var rt=J[tt],ht=nt[rt],at=Object.create(null),st=0;st<ht.length;st++){var ut=ht[st];if(ut.include){var Et=[st,1];if(ut.include!==rt&&!at[ut.include]){at[ut.include]=!0;var yt=nt[ut.include];if(!yt)throw new Error("Cannot include nonexistent state '"+ut.include+"' (in state '"+rt+"')");for(var St=0;St<yt.length;St++){var Ot=yt[St];ht.indexOf(Ot)===-1&&Et.push(Ot)}}ht.splice.apply(ht,Et),st--}}for(var ft=Object.create(null),tt=0;tt<J.length;tt++){var rt=J[tt];ft[rt]=gt(nt[rt],!0)}for(var tt=0;tt<J.length;tt++){for(var bt=J[tt],Pt=ft[bt],Tt=Pt.groups,st=0;st<Tt.length;st++)xt(Tt[st],bt,ft);for(var At=Object.getOwnPropertyNames(Pt.fast),st=0;st<At.length;st++)xt(Pt.fast[At[st]],bt,ft)}return new lt(ft,Q)}function vt(G){for(var Q=typeof Map<"u",X=Q?new Map:Object.create(null),J=Object.getOwnPropertyNames(G),nt=0;nt<J.length;nt++){var tt=J[nt],rt=G[tt],ht=Array.isArray(rt)?rt:[rt];ht.forEach(function(at){if(typeof at!="string")throw new Error("keyword must be string (in keyword '"+tt+"')");Q?X.set(at,tt):X[at]=tt})}return function(at){return Q?X.get(at):X[at]}}var lt=function(G,Q){this.startState=Q,this.states=G,this.buffer="",this.stack=[],this.reset()};lt.prototype.reset=function(G,Q){return this.buffer=G||"",this.index=0,this.line=Q?Q.line:1,this.col=Q?Q.col:1,this.queuedToken=Q?Q.queuedToken:null,this.queuedText=Q?Q.queuedText:"",this.queuedThrow=Q?Q.queuedThrow:null,this.setState(Q?Q.state:this.startState),this.stack=Q&&Q.stack?Q.stack.slice():[],this},lt.prototype.save=function(){return{line:this.line,col:this.col,state:this.state,stack:this.stack.slice(),queuedToken:this.queuedToken,queuedText:this.queuedText,queuedThrow:this.queuedThrow}},lt.prototype.setState=function(G){if(!(!G||this.state===G)){this.state=G;var Q=this.states[G];this.groups=Q.groups,this.error=Q.error,this.re=Q.regexp,this.fast=Q.fast}},lt.prototype.popState=function(){this.setState(this.stack.pop())},lt.prototype.pushState=function(G){this.stack.push(this.state),this.setState(G)};var Bt=N?function(G,Q){return G.exec(Q)}:function(G,Q){var X=G.exec(Q);return X[0].length===0?null:X};lt.prototype._getGroup=function(G){for(var Q=this.groups.length,X=0;X<Q;X++)if(G[X+1]!==void 0)return this.groups[X];throw new Error("Cannot find token type for matched text")};function Ut(){return this.value}if(lt.prototype.next=function(){var G=this.index;if(this.queuedGroup){var Q=this._token(this.queuedGroup,this.queuedText,G);return this.queuedGroup=null,this.queuedText="",Q}var X=this.buffer;if(G!==X.length){var rt=this.fast[X.charCodeAt(G)];if(rt)return this._token(rt,X.charAt(G),G);var J=this.re;J.lastIndex=G;var nt=Bt(J,X),tt=this.error;if(nt==null)return this._token(tt,X.slice(G,X.length),G);var rt=this._getGroup(nt),ht=nt[0];return tt.fallback&&nt.index!==G?(this.queuedGroup=rt,this.queuedText=ht,this._token(tt,X.slice(G,nt.index),G)):this._token(rt,ht,G)}},lt.prototype._token=function(G,Q,X){var J=0;if(G.lineBreaks){var nt=/\n/g,tt=1;if(Q===`
`)J=1;else for(;nt.exec(Q);)J++,tt=nt.lastIndex}var rt={type:typeof G.type=="function"&&G.type(Q)||G.defaultType,value:typeof G.value=="function"?G.value(Q):Q,text:Q,toString:Ut,offset:X,lineBreaks:J,line:this.line,col:this.col},ht=Q.length;if(this.index+=ht,this.line+=J,J!==0?this.col=ht-tt+1:this.col+=ht,G.shouldThrow){var at=new Error(this.formatError(rt,"invalid syntax"));throw at}return G.pop?this.popState():G.push?this.pushState(G.push):G.next&&this.setState(G.next),rt},typeof Symbol<"u"&&Symbol.iterator){var It=function(G){this.lexer=G};It.prototype.next=function(){var G=this.lexer.next();return{value:G,done:!G}},It.prototype[Symbol.iterator]=function(){return this},lt.prototype[Symbol.iterator]=function(){return new It(this)}}return lt.prototype.formatError=function(G,Q){if(G==null)var X=this.buffer.slice(this.index),G={text:X,offset:this.index,lineBreaks:X.indexOf(`
`)===-1?0:1,line:this.line,col:this.col};var J=2,nt=Math.max(G.line-J,1),tt=G.line+J,rt=String(tt).length,ht=pt(this.buffer,this.line-G.line+J+1).slice(0,5),at=[];at.push(Q+" at line "+G.line+" col "+G.col+":"),at.push("");for(var st=0;st<ht.length;st++){var ut=ht[st],Et=nt+st;at.push(ot(String(Et),rt)+"  "+ut),Et===G.line&&at.push(ot("",rt+G.col+1)+"^")}return at.join(`
`)},lt.prototype.clone=function(){return new lt(this.states,this.state)},lt.prototype.has=function(G){return!0},{compile:wt,states:Nt,error:Object.freeze({error:!0}),fallback:Object.freeze({fallback:!0}),keywords:vt}})})(moo$1);var mooExports=moo$1.exports;const moo=getDefaultExportFromCjs(mooExports);var BitcoinVMCommand=(i=>(i[i.PushConstant=0]="PushConstant",i[i.PushUConstant=1]="PushUConstant",i[i.PushBytes=2]="PushBytes",i[i.PushString=3]="PushString",i[i.OpCode=4]="OpCode",i[i.TagStack=5]="TagStack",i[i.GetTagIndex=6]="GetTagIndex",i[i.PickTag=7]="PickTag",i[i.RollTag=8]="RollTag",i))(BitcoinVMCommand||{});const BITCOIN_MAINNET_OP_CODES=["OP_0","OP_1","OP_2","OP_3","OP_4","OP_5","OP_6","OP_7","OP_8","OP_9","OP_10","OP_11","OP_12","OP_13","OP_14","OP_15","OP_16","OP_NOP","OP_IF","OP_ENDIF","OP_ELSE","OP_TOALTSTACK","OP_FROMALTSTACK","OP_IFDUP","OP_DEPTH","OP_DROP","OP_DUP","OP_NIP","OP_OVER","OP_PICK","OP_ROLL","OP_ROT","OP_SWAP","OP_TUCK","OP_2DROP","OP_2DUP","OP_3DUP","OP_2OVER","OP_2ROT","OP_2SWAP","OP_SIZE","OP_EQUAL","OP_EQUALVERIFY","OP_1ADD","OP_1SUB","OP_NEGATE","OP_ABS","OP_NOT","OP_0NOTEQUAL","OP_ADD","OP_SUB","OP_BOOLAND","OP_BOOLOR","OP_NUMEQUAL","OP_NUMEQUALVERIFY","OP_NUMNOTEQUAL","OP_LESSTHAN","OP_GREATERTHAN","OP_LESSTHANOREQUAL","OP_GREATERTHANOREQUAL","OP_MIN","OP_MAX","OP_WITHIN","OP_RIPEMD160","OP_SHA1","OP_SHA256","OP_HASH160","OP_HASH256","OP_CODESEPARATOR","OP_CHECKSIG","OP_CHECKSIGVERIFY","OP_CHECKMULTISIG","OP_CHECKMULTISIGVERIFY","OP_CHECKSIGADD","OP_CHECKLOCKTIMEVERIFY","OP_CHECKSEQUENCEVERIFY","OP_VERIFY","END_EXAMPLE_WITNESS","OP_RETURN","OP_CHECKGROTH16VERIFY"],LIQUID_OP_CODES=["OP_SHA256INITIALIZE","OP_SHA256UPDATE","OP_SHA256FINALIZE","OP_INSPECTINPUTOUTPOINT","OP_INSPECTINPUTASSET","OP_INSPECTINPUTVALUE","OP_INSPECTINPUTSCRIPTPUBKEY","OP_INSPECTINPUTSEQUENCE","OP_INSPECTINPUTISSUANCE","OP_PUSHCURRENTINPUTINDEX","OP_INSPECTOUTPUTASSET","OP_INSPECTOUTPUTVALUE","OP_INSPECTOUTPUTNONCE","OP_INSPECTOUTPUTSCRIPTPUBKEY","OP_INSPECTVERSION","OP_INSPECTLOCKTIME","OP_INSPECTNUMINPUTS","OP_INSPECTNUMOUTPUTS","OP_TXWEIGHT","OP_ADD64","OP_SUB64","OP_MUL64","OP_DIV64","OP_NEG64","OP_LESSTHAN64","OP_LESSTHANOREQUAL64","OP_GREATERTHAN64","OP_GREATERTHANOREQUAL64","OP_SCRIPTNUMTOLE64","OP_LE64TOSCRIPTNUM","OP_LE32TOLE64","OP_TWEAKVERIFY","OP_CAT","OP_AND","OP_OR","OP_XOR"];class ParserError extends Error{constructor(e,s,N){super(e),this.lineNumber=s,this.index=N;const B=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,B):this.__proto__=B}toString(){return`[L${this.lineNumber}:I${this.index}] ${this.message}`}}class BitcoinAssemblyParser{constructor(e,s){this.commands=[],this.allowedOpCodes=BITCOIN_MAINNET_OP_CODES,this.lexer=e,s.vmMode==="liquid"&&(this.allowedOpCodes=BITCOIN_MAINNET_OP_CODES.concat(LIQUID_OP_CODES))}parse(e){for(this.lexer.reset(e),this.commands=[];this.parseCommand(this.nextIgnoreWhitespaceAndComments()););return this.commands}errorAtCurrentToken(e){return new ParserError(e,this.lexer.line,this.lexer.col)}expectPrefix(e){const s=this.nextIgnoreWhitespaceAndComments();if(!s)throw this.errorAtCurrentToken("Unexpected end of input");if(!s.type)throw this.errorAtCurrentToken("Unexpected token "+s.value);if(s.type.substring(0,e.length)!==e)throw this.errorAtCurrentToken("Expected prefix "+e+" but got "+s.type);return s}nextIgnoreWhitespaceAndComments(){let e=this.lexer.next();if(!e||!e.type)return e;let s=e.type.indexOf("_"),N=s===-1?e:e.type.substring(0,s);for(;e&&(N==="space"||N==="comment");)if(e=this.lexer.next(),e&&e.type)s=e.type.indexOf("_"),N=s===-1?e:e.type.substring(0,s);else return e;return e}expect(e){const s=this.nextIgnoreWhitespaceAndComments();if(!s)throw this.errorAtCurrentToken("Unexpected end of input");if(!s.type)throw this.errorAtCurrentToken("Unexpected token "+s.value);if(s.type!==e)throw this.errorAtCurrentToken("Expected type "+e+" but got "+s.type);return s}parseCommand(e){if(!e||!e.type)return!1;if(e.type==="op_identifier"){const s=e.value.toUpperCase();if(this.allowedOpCodes.indexOf(s)===-1)throw this.errorAtCurrentToken("Invalid or disabled opcode "+s);this.commands.push({cmd:BitcoinVMCommand.OpCode,op:s,lineNumber:this.lexer.line,startIndex:this.lexer.col,endIndex:this.lexer.col+e.value.length})}else this.lexer.state==="data"?this.commands.push(this.parseData()):(this.lexer.state==="tag"||this.lexer.state==="rollTag"||this.lexer.state==="pickTag")&&this.parseTags();return!0}parseTags(){let e=BitcoinVMCommand.TagStack;this.lexer.state==="rollTag"?e=BitcoinVMCommand.RollTag:this.lexer.state==="pickTag"?e=BitcoinVMCommand.PickTag:this.lexer.state==="tag"&&(e=BitcoinVMCommand.TagStack);const s=this.lexer.col;let N=this.nextIgnoreWhitespaceAndComments(),B=[];for(;N&&N.type==="tag_identifier";)for(B.push(N.value.trim()),N=this.nextIgnoreWhitespaceAndComments();N&&N.type==="comma";)N=this.nextIgnoreWhitespaceAndComments();if(this.commands.push({cmd:e,tags:B,lineNumber:this.lexer.line,startIndex:s,endIndex:this.lexer.col}),e===BitcoinVMCommand.RollTag){if(!N||N.type!=="r_curley")throw this.errorAtCurrentToken("Expected }")}else if(e===BitcoinVMCommand.PickTag){if(!N||N.type!=="r_square")throw this.errorAtCurrentToken("Expected ]")}else this.parseCommand(N)}parseData(){const e=this.expectPrefix("data_");let s=null;if(e.type==="data_string")s={cmd:BitcoinVMCommand.PushString,value:e.value,lineNumber:this.lexer.line,startIndex:this.lexer.col,endIndex:this.lexer.col+e.value.length};else if(e.type==="data_hex")s={cmd:BitcoinVMCommand.PushBytes,value:hexToU8Array(e.value),lineNumber:this.lexer.line,startIndex:this.lexer.col,endIndex:this.lexer.col+e.value.length};else if(e.type==="data_bin")s={cmd:BitcoinVMCommand.PushUConstant,value:parseInt(e.value,10),lineNumber:this.lexer.line,startIndex:this.lexer.col,endIndex:this.lexer.col+e.value.length};else if(e.type==="data_integer")s={cmd:BitcoinVMCommand.PushConstant,value:parseInt(e.value,10),lineNumber:this.lexer.line,startIndex:this.lexer.col,endIndex:this.lexer.col+e.value.length};else throw this.errorAtCurrentToken("Unexpected token "+e.type);if(s)return this.expect("end_data"),s;throw this.errorAtCurrentToken("Unexpected token "+e.type)}}function getLexer(){return moo.states({main:{include:["comment"],start_data:{match:"<",push:"data"},op_identifier:/[a-z|A-Z||0-9|_]+/,space_new_line:{match:/\s+/,lineBreaks:!0},hashtag:{match:/#/,push:"tag"},l_square:{match:/\[/,push:"pickTag"},l_curley:{match:/\{/,push:"rollTag"}},comment:{comment_line:/\/\/.+/,comment_block:/\/\*[^]*?\*\//},tag:{tag_identifier:/[^#,\[\]\{\}\@\<\>\n]+/,comma:",",space_new_line:{match:/\n/,lineBreaks:!0,pop:1},space:{match:/\s+/,lineBreaks:!0}},rollTag:{tag_identifier:/[^#,\[\]\{\}\@\<\>\n]+/,comma:",",r_curley:{match:/\}/,pop:1},space:{match:/\s+/,lineBreaks:!0}},pickTag:{tag_identifier:/[^#,\[\]\{\}\@\<\>\n]+/,comma:",",r_square:{match:/\]/,pop:1},space:{match:/\s+/,lineBreaks:!0}},data:{data_string:[{match:/"(?:\\["\\rn]|[^"\\])*?"/,lineBreaks:!0,value:i=>i.slice(1,-1)},{match:/'(?:\\['\\rn]|[^'\\])*?'/,lineBreaks:!0,value:i=>i.slice(1,-1)}],data_hex:/0x[0-9|a-f|A-F]+/,data_bin:/0b[01]+/,data_integer:/-?[0-9]+/,end_data:{match:">",push:"main"}}})}function vmScriptCompile(i,e=[],s=DEFAULT_BITCOIN_EXECUTION_CONFIG){const N=(s.vmMode==="bitcoin"?BITCOIN_MAINNET_OP_CODES:BITCOIN_MAINNET_OP_CODES.concat(LIQUID_OP_CODES)).concat(e),B=getLexer(),q=new BitcoinAssemblyParser(B,s);return q.allowedOpCodes=N,q.parse(i)}function vmScriptExecute(i,e,s=DEFAULT_BITCOIN_EXECUTION_CONFIG){const N=e||new BitcoinComplexVMTraceBuilder([]);s&&(N.executionConfig=s);for(let B=0;B<i.length;B++){const q=i[B];if(q.cmd===BitcoinVMCommand.PushConstant)N.constant(q.value);else if(q.cmd===BitcoinVMCommand.PushUConstant)N.uconstant(BigInt(q.value));else if(q.cmd===BitcoinVMCommand.PushBytes)N.hexBytes(u8ArrayToHex(q.value));else if(q.cmd===BitcoinVMCommand.PushString)N.constant(q.value);else if(q.cmd===BitcoinVMCommand.OpCode){const V=N[q.op];if(typeof V=="function")V.bind(N)();else throw new Error("missing op code "+q.op+" in trace builder")}else if(q.cmd===BitcoinVMCommand.GetTagIndex)for(let V of q.tags)N.selectTagIndex(V);else q.cmd===BitcoinVMCommand.PickTag?N.pickTag(q.tags):q.cmd===BitcoinVMCommand.RollTag?N.rollTag(q.tags):q.cmd===BitcoinVMCommand.TagStack&&N.tag(q.tags)}return N}function execBasm(i,e,s,N=DEFAULT_BITCOIN_EXECUTION_CONFIG){const B=vmScriptCompile(s,i,N);return vmScriptExecute(B,e,N)}function getExecBasm(i=DEFAULT_BITCOIN_EXECUTION_CONFIG){return(e,s,N)=>execBasm(e,s,N,i)}function executePreparedBitIDEAsmScript(i){const e=getCustomOpsCompiled(i.customOps),s=[],N=Y=>{if(Y.handlingCustomOpCode===0){const it=Y.customOps[Y.customOps.length-1];if(it){const Z=Y.getStackSnapshot();s.push({op:it,...Z})}}},B=new BitcoinComplexVMTraceBuilder([],!0,!0,N),q=vmScriptCompile(i.code,Object.keys(e),i.executionConfig),V=B.getInstanceWithCustomOpCodes(e);return V.executionConfig=i.executionConfig,vmScriptExecute(q,V,i.executionConfig),{fileName:i.fileName,snapshots:s.map(Y=>serializeTaggedSnapshot(Y)),compiled:B.getBitcoinScript()}}function getCustomOpsCompiled(ops,executionConfig=DEFAULT_BITCOIN_EXECUTION_CONFIG){const output={},executor=getExecBasm(executionConfig);return Object.keys(ops).forEach(opName=>{try{output[opName]=eval(ops[opName])(executor)}catch(i){throw console.error(i),new Error("Error compiling custom op code: "+opName+": "+i)}}),output}function executePreparedBitIDEScript(prepared){if(isBitIDEScript(prepared.fileName))return executePreparedBitIDEAsmScript(prepared);const customOps=getCustomOpsCompiled(prepared.customOps,prepared.executionConfig),stackList=[],recorder=i=>{if(i.handlingCustomOpCode===0){const e=i.customOps[i.customOps.length-1];if(e){const s=i.getStackSnapshot();stackList.push({op:e,...s})}}},tbBase=new BitcoinComplexVMTraceBuilder([],!0,!0,recorder,prepared.executionConfig),tb=tbBase.getInstanceWithCustomOpCodes(customOps);try{eval(`
    (function (tb){
      const b = tb;
      const scriptHelpers = tb.getScriptHelpers(), sch = scriptHelpers;
      ${prepared.code}
    })
  `)(tb)}catch(i){throw console.error(i),new Error("Error executing script: "+prepared.fileName+": "+i)}return{fileName:prepared.fileName,snapshots:stackList.map(i=>serializeTaggedSnapshot(i)),compiled:tbBase.getBitcoinScript()}}function indexOfEndExampleWitness(i){for(let e=0,s=i.length;e<s;e++){const N=i[e];if(N.cmd===BitcoinVMCommand.OpCode&&N.op==="END_")return e}return-1}function compileOpsToHexPushAsm(i,e=DEFAULT_BITCOIN_EXECUTION_CONFIG){const s=vmScriptCompile(i.join(`
`),[],e),N=[];for(const B of s)if(B.cmd===BitcoinVMCommand.OpCode)N.push(B.op);else if(B.cmd===BitcoinVMCommand.PushBytes)N.push(u8ArrayToHex(B.value));else if(B.cmd===BitcoinVMCommand.PushConstant)N.push(u8ArrayToHex(bigIntToLEBytesMin(typeof B.value=="bigint"?B.value:BigInt(B.value))));else if(B.cmd===BitcoinVMCommand.PushUConstant)N.push(u8ArrayToHex(bigIntToLEBytes(typeof B.value=="bigint"?B.value:BigInt(B.value))));else if(B.cmd===BitcoinVMCommand.PushString)N.push(u8ArrayToHex(new TextEncoder().encode(B.value)));else throw new Error("unsuppored hex push compile op command type: "+B.cmd);return N.join(" ")}function compilePreparedBitIDEAsmScript(i){const e=getCustomOpsCompiled(i.customOps,i.executionConfig),s=vmScriptCompile(i.code,Object.keys(e),i.executionConfig),N=indexOfEndExampleWitness(s);if(i.executionEnabled){const B=new BitcoinComplexVMTraceBuilder([],!0,!0);B.executionConfig=i.executionConfig,B.disableExecutionAfterWitness=!1;const q=B.getInstanceWithCustomOpCodes(e);try{const V=vmScriptExecute(s,q,i.executionConfig).getBitcoinScriptAndWitness();return{fileName:i.fileName,compiled:compileOpsToHexPushAsm(V.ops,i.executionConfig),witnessStackHex:V.witnessStack.map(Y=>stackItemToHex(Y.value)),witnessStack:V.witnessStack.map(Y=>serializeStackItem(Y.value)),endSnapshot:serializeTaggedSnapshot({op:q.ops[q.ops.length-1]||"",...q.getStackSnapshot()})}}catch(V){console.error(V);const Y=new BitcoinComplexVMTraceBuilder([],N!==-1,!0);Y.disableExecutionAfterWitness=!0,Y.executionConfig=i.executionConfig;const it=Y.getInstanceWithCustomOpCodes(e),Z=vmScriptExecute(s,it,i.executionConfig).getBitcoinScriptAndWitness();return{fileName:i.fileName,compiled:compileOpsToHexPushAsm(Z.ops,i.executionConfig),witnessStackHex:Z.witnessStack.map(et=>stackItemToHex(et.value)),witnessStack:Z.witnessStack.map(et=>serializeStackItem(et.value)),executionError:{message:V+"",op:q.ops[q.ops.length-1]||"",opIndex:q.ops.length-1-q.endWitnessOpIndex}}}}else{const B=new BitcoinComplexVMTraceBuilder([],N!==-1,!0);B.executionConfig=i.executionConfig,B.disableExecutionAfterWitness=!0;const q=B.getInstanceWithCustomOpCodes(e),V=vmScriptExecute(s,q,i.executionConfig).getBitcoinScriptAndWitness();return{fileName:i.fileName,compiled:compileOpsToHexPushAsm(V.ops,i.executionConfig),witnessStackHex:V.witnessStack.map(Y=>stackItemToHex(Y.value)),witnessStack:V.witnessStack.map(Y=>serializeStackItem(Y.value))}}}function compilePreparedBitIDEScript(compileSession){if(isBitIDEScript(compileSession.fileName))return compilePreparedBitIDEAsmScript(compileSession);const customOps=getCustomOpsCompiled(compileSession.customOps,compileSession.executionConfig);let executor=null;try{executor=eval(`
    (function (tb){
      const b = tb;
      const scriptHelpers = tb.getScriptHelpers(), sch = scriptHelpers;
      ${compileSession.code}
    })`)}catch(i){throw console.error(i),new Error("Error executing script: "+compileSession.fileName+": "+i)}if(compileSession.executionEnabled){const i=new BitcoinComplexVMTraceBuilder([],!0,!0);i.disableExecutionAfterWitness=!1,i.executionConfig=compileSession.executionConfig;const e=i.getInstanceWithCustomOpCodes(customOps);try{executor(e);const s=e.getBitcoinScriptAndWitness();return{fileName:compileSession.fileName,compiled:compileOpsToHexPushAsm(s.ops,compileSession.executionConfig),witnessStackHex:s.witnessStack.map(N=>stackItemToHex(N.value)),witnessStack:s.witnessStack.map(N=>serializeStackItem(N.value)),endSnapshot:serializeTaggedSnapshot({op:e.ops[e.ops.length-1]||"",...e.getStackSnapshot()})}}catch(s){const N=!!e.witnessStack,B=new BitcoinComplexVMTraceBuilder([],N,!0);B.disableExecutionAfterWitness=!0,B.executionConfig=compileSession.executionConfig;const q=B.getInstanceWithCustomOpCodes(customOps);executor(q);const V=q.getBitcoinScriptAndWitness();return{fileName:compileSession.fileName,compiled:compileOpsToHexPushAsm(V.ops,compileSession.executionConfig),witnessStackHex:V.witnessStack.map(Y=>stackItemToHex(Y.value)),witnessStack:V.witnessStack.map(Y=>serializeStackItem(Y.value)),executionError:{message:s+"",op:e.ops[e.ops.length-1]||"",opIndex:e.ops.length-1-e.endWitnessOpIndex}}}}else{const i=new BitcoinComplexVMTraceBuilder([],!0,!0);i.disableExecutionAfterWitness=!0,i.executionConfig=compileSession.executionConfig;const e=i.getInstanceWithCustomOpCodes(customOps);try{executor(e);const s=e.getBitcoinScriptAndWitness();return{fileName:compileSession.fileName,compiled:compileOpsToHexPushAsm(s.ops,compileSession.executionConfig),witnessStackHex:s.witnessStack.map(N=>stackItemToHex(N.value)),witnessStack:s.witnessStack.map(N=>serializeStackItem(N.value))}}catch{const N=!!e.witnessStack,B=new BitcoinComplexVMTraceBuilder([],N,!0);B.disableExecutionAfterWitness=!0,B.executionConfig=compileSession.executionConfig;const q=B.getInstanceWithCustomOpCodes(customOps);executor(q);const V=q.getBitcoinScriptAndWitness();return{fileName:compileSession.fileName,compiled:compileOpsToHexPushAsm(V.ops,compileSession.executionConfig),witnessStackHex:V.witnessStack.map(Y=>stackItemToHex(Y.value)),witnessStack:V.witnessStack.map(Y=>serializeStackItem(Y.value))}}}}class M{constructor(e){if(this.counter=0,e.length!==7)throw new Error("you must provide 7 random bytes for the iv generator");this.iv=new Uint8Array(12),this.ivU32View=new Uint32Array(this.iv.buffer),this.iv.set(e,5)}setCounter(e){if(e>0xffffffffff)throw new Error("counter overflow, must be less than 0xffffffffff");const s=(e&4294967295)>>>0;this.ivU32View[0]=s,this.iv[5]=Math.floor(e/4294967296),this.counter=e}nextIv(){return this.setCounter(this.counter+1),this.iv.slice(0,12)}}const H=function(){const i="0123456789abcdef",e=new Array(256);for(let s=0;s<16;++s){const N=s*16;for(let B=0;B<16;++B)e[N+B]=i[s]+i[B]}return e}();function h(i){let e="";for(let s=0,N=i.length;s<N;s++)e+=H[i[s]];return e}function d(i){const e=Math.floor(i.length/2),s=new Uint8Array(e);for(let N=0;N<e;N++)s[N]=parseInt(i.substring(N*2,N*2+2),16);return s}function g(i,e){if(i instanceof Uint8Array&&e instanceof Uint8Array){const s=i.length;if(s===e.length){for(let N=0;N<s;N++)if(i[N]!==e[N])return!1;return!0}}return!1}function p(i,e=0){return(i[e]|i[e+1]<<8|i[e+2]<<16|i[e+3]<<24)>>>0}function A(i,e,s=0){e[s]=i&255,e[s+1]=i>>8&255,e[s+2]=i>>16&255,e[s+3]=i>>24&255}function v(i,e=0){return i[e]|i[e+1]<<8}function P(i,e,s=0){e[s]=i&255,e[s+1]=i>>8&255}const y=class{constructor(i,e,s,N,B){this.initialized=!1,this.counter=0,this.authenticationKey=i,this.encryptionKey=e,this.cryptoImplementation=s,this.identity=N,this.identityHex=h(N),this.peerIdentity=B,this.peerIdentityHex=h(B)}static async newRandomSession(i){const e=i||y.defaultCryptoImplementation,s=await e.generateRandomSignatureKey(),N=await e.generateRandomEncryptionKey(),B=e.randomBytes(12),q=e.randomBytes(12);return new y(s,N,e,B,q)}async generatePeerSessionConfig(){const i=await this.authenticationKey.exportKey(),e=await this.encryptionKey.exportKey();return{peerIdentityHex:h(this.identity),identityHex:h(this.peerIdentity),encryptionKeyHex:h(e),authenticationKeyHex:h(i)}}static async fromPeerSessionInfo(i,e){const s=e||y.defaultCryptoImplementation,N=d(i.identityHex),B=d(i.peerIdentityHex),q=await s.importSignatureKey(d(i.authenticationKeyHex)),V=await s.importEncryptionKey(d(i.encryptionKeyHex));return new y(q,V,s,N,B)}isMessageFromPeerIdentity(i){return g(i.toIdentity,this.identity)&&g(i.fromIdentity,this.peerIdentity)}async encryptMessageForPeer(i){const e=await this.encryptionKey.encrypt(i),s=await this.authenticationKey.sign(e);return{fromIdentity:this.identity,toIdentity:this.peerIdentity,signature:s,payload:e}}async decryptMessageFromPeer(i){if(!await this.authenticationKey.verify(i.signature,i.payload))throw new Error("error decrypting message from peer: invalid signature");return await this.encryptionKey.decrypt(i.payload)}};let w$1=y;w$1.defaultCryptoImplementation={};var l=(i=>(i[i.Success=0]="Success",i[i.UnknownError=1]="UnknownError",i[i.UnregisteredFunctionError=2]="UnregisteredFunctionError",i[i.RuntimeError=3]="RuntimeError",i[i.DecodeResponseError=4]="DecodeResponseError",i[i.DecodeArgumentsError=5]="DecodeArgumentsError",i[i.EncodeResponseError=6]="EncodeResponseError",i))(l||{});const U=6;var c=(i=>(i[i.Call=0]="Call",i[i.Response=1]="Response",i[i.Unknown=2]="Unknown",i))(c||{});function O(i){return i===0?"Success":i===2?"UnregisteredFunctionError":i===3?"RuntimeError":i===4?"DecodeResponseError":i===5?"DecodeArgumentsError":"UnknownError"}function K(i){return new TextEncoder().encode(JSON.stringify(i))}function $(i){return JSON.parse(new TextDecoder().decode(i))}const m=101,E=82,b=80,x=67;function f$1(i,e,s){i[0]=m,i[1]=E,i[2]=b,i[3]=x,i[4]=e,A(s,i,5)}function u(i,e,s){if(!s||!s.byteLength){const B=new Uint8Array(10);return f$1(B,c.Response,i),B[9]=e,B}const N=new Uint8Array(s.length+10);return f$1(N,c.Response,i),N[9]=e,N.set(s,10),N}function j(i){const e=i.length;if(e<10)throw new Error("invalid message length, missing function name");const s=p(i,5),N=i[9]>U?l.UnknownError:i[9];return N===l.Success?{messageType:c.Response,callId:s,responseCode:l.Success,response:e===10?void 0:i.subarray(10)}:{messageType:c.Response,callId:s,responseCode:N,errorMessage:e===10?void 0:new TextDecoder().decode(i.subarray(10))}}function k(i,e,s){const N=new TextEncoder().encode(e),B=s?s.length:0,q=N.length,V=new Uint8Array(11+q+B);return f$1(V,c.Call,i),P(q,V,9),V.set(N,11),B&&s&&V.set(s,11+q),V}function F(i){const e=i.length;if(e<=11)throw new Error("invalid message length, missing function name");const s=p(i,5),N=11+v(i,9);if(e<N)throw new Error("invalid function name length");const B=new TextDecoder().decode(i.subarray(11,N));return N===e?{messageType:c.Call,callId:s,functionName:B}:{messageType:c.Call,functionName:B,callId:s,payload:i.subarray(N)}}function D(i){if(i.length>9&&i[0]===m&&i[1]===E&&i[2]===b&&i[3]===x){const e=i[4];if(e===c.Call||e===c.Response)return e}return c.Unknown}function S(i){const e=D(i);if(e===c.Call)return F(i);if(e===c.Response)return j(i);throw new Error("invalid message header")}function C$1(i){return Object.getOwnPropertyNames(Object.getPrototypeOf(i)).filter(e=>typeof i[e]=="function"&&e!=="constructor"&&e.indexOf("__")===-1&&!e.startsWith("no_rpc_"))}const L={get(i,e,s){return N=>i.callRPC(e,N)}};function I(i){return new Proxy(i,L)}function R(i,e,s){const N=I(i),B=e(N,i),q=typeof s=="object"&&s,V=q&&typeof s.blacklist=="object"&&Array.isArray(s.blacklist);return q&&typeof s.whitelist=="object"&&Array.isArray(s.whitelist)?s.whitelist.forEach(Y=>{(!V||s.blacklist.indexOf(Y)===-1)&&typeof B[Y]=="function"&&i.registerRPCFunction(Y,B[Y].bind(B))}):(V?C$1(B).filter(Y=>s.blacklist.indexOf(Y)===-1):C$1(B)).forEach(Y=>{typeof B[Y]=="function"&&i.registerRPCFunction(Y,B[Y].bind(B))}),B}class z{constructor(e,s){this.rpcHandlerRegistry={},this.callIdCounter=0,this.awaitingCalls={},this.hub=e,this.serializer=s||{serialize:K,deserialize:$},this.onEncodedMessage=this.onEncodedMessage.bind(this),e.addMessageListener(this.onEncodedMessage)}registerRPCFunction(e,s){if(e.length>65535)throw new Error("function name must be less than 65535 characters");if(typeof this.rpcHandlerRegistry[e]=="function")throw new Error("a function with the name '"+e+"' has already been registered");this.rpcHandlerRegistry[e]=s}callRPC(e,s){const N=this.callIdCounter++;return new Promise((B,q)=>{try{const V=s?this.serializer.serialize(s):void 0;this.awaitingCalls[N]={resolve:B,reject:q},this.hub.send(k(N,e,V)).then(()=>0).catch(Y=>{delete this.awaitingCalls[N],q(Y)})}catch(V){return q(V)}})}async onEncodedCallMessage(e){if(e.functionName.length&&Object.hasOwnProperty.call(this.rpcHandlerRegistry,e.functionName)&&typeof this.rpcHandlerRegistry[e.functionName]=="function"){let s;try{if(e.payload){const N=this.serializer.deserialize(e.payload);s=await this.rpcHandlerRegistry[e.functionName](N)}else s=await this.rpcHandlerRegistry[e.functionName]()}catch(N){return this.hub.send(u(e.callId,l.RuntimeError,new TextEncoder().encode(N+"")))}if(typeof s<"u"){let N;try{N=this.serializer.serialize(s)}catch(B){return this.hub.send(u(e.callId,l.EncodeResponseError,new TextEncoder().encode(B+"")))}return this.hub.send(u(e.callId,l.Success,N))}else return this.hub.send(u(e.callId,l.Success))}else return this.hub.send(u(e.callId,l.UnregisteredFunctionError))}onEncodedResponseMessage(e){if(Object.hasOwnProperty.call(this.awaitingCalls,e.callId)&&this.awaitingCalls[e.callId]&&typeof this.awaitingCalls[e.callId]=="object"){const s=this.awaitingCalls[e.callId];if(delete this.awaitingCalls[e.callId],e.responseCode===l.Success)try{if(e.response){let N;try{N=this.serializer.deserialize(e.response)}catch(B){return s.reject(new Error("error decoding response: "+B))}s.resolve(N)}else s.resolve()}catch{}else s.reject(new Error(O(e.responseCode)+(e.errorMessage?": "+e.errorMessage:"")))}}onEncodedMessage(e){const s=S(e);s.messageType===c.Call?this.onEncodedCallMessage(s).then(()=>0).catch(N=>console.error("error in on enc call msg",N)):s.messageType===c.Response&&this.onEncodedResponseMessage(s)}dispose(){this.hub.dispose()}registerHandlerArray(e){return e.forEach(s=>this.registerRPCFunction(s.name,s.handler)),this}registerHandlerMap(e){if(e instanceof Map)for(const[s,N]of e)this.registerRPCFunction(s,N);else Object.keys(e).forEach(s=>{this.registerRPCFunction(s,e[s])});return this}withHandlers(e,s){const N=typeof s=="object"&&s,B=N&&typeof s.blacklist=="object"&&Array.isArray(s.blacklist),q=N&&typeof s.whitelist=="object"&&Array.isArray(s.whitelist);if(Array.isArray(e)){const V=N?e.filter(Y=>(!q||s.whitelist.indexOf(Y.name)!==-1)&&(!B||s.blacklist.indexOf(Y.name)===-1)):e;this.registerHandlerArray(V)}else if(e instanceof Map)for(const[V,Y]of e)(!q||s.whitelist.indexOf(V)!==-1)&&(!B||s.blacklist.indexOf(V)===-1)&&this.registerRPCFunction(V,Y);else Object.keys(e).forEach(V=>{(!q||s.whitelist.indexOf(V)!==-1)&&(!B||s.blacklist.indexOf(V)===-1)&&this.registerRPCFunction(V,e[V])});return this}registerHandlerClass(e,s){return R(this,e,s)}}class T{constructor(e,s,N=q=>console.error(q),B){this.messageListeners=[],this.session=e,this.channel=s,this.onMessageHandlerError=N,this.onDecryptionError=B,this.onEncryptedMessage=this.onEncryptedMessage.bind(this),this.onDecryptedMessage=this.onDecryptedMessage.bind(this),this.channel.addMessageListener(this.onEncryptedMessage)}onEncryptedMessage(e){this.session.isMessageFromPeerIdentity(e)&&this.session.decryptMessageFromPeer(e).then(s=>this.onDecryptedMessage(s)).catch(s=>{console.error("error",s),typeof this.onDecryptionError=="function"&&this.onDecryptionError(s)})}addMessageListener(e){this.messageListeners.indexOf(e)===-1&&this.messageListeners.push(e)}removeMessageListener(e){const s=this.messageListeners.indexOf(e);s!==-1&&(this.messageListeners=this.messageListeners.slice(0,s).concat(this.messageListeners.slice(s+1)))}onDecryptedMessage(e){const s=this.messageListeners;for(const N of s)try{N(e)}catch(B){typeof this.onMessageHandlerError=="function"&&this.onMessageHandlerError(B)}}dispose(){this.channel.removeMessageListener(this.onEncryptedMessage)}async send(e){const s=await this.session.encryptMessageForPeer(e);await this.channel.sendMessageRaw(s)}}function _(i){const e=i.split("-");if(e.length!==4)throw new Error("error parsing serialized peer session config");return{encryptionKeyHex:e[0],authenticationKeyHex:e[1],identityHex:e[2],peerIdentityHex:e[3]}}const r=12;class n{constructor(e){this.key=e}async sign(e){const s=await window.crypto.subtle.sign({name:"HMAC"},this.key,e);return new Uint8Array(s)}async verify(e,s){return await window.crypto.subtle.verify({name:"HMAC"},this.key,e,s)}async exportKey(){const e=await window.crypto.subtle.exportKey("raw",this.key);return new Uint8Array(e)}static async importKey(e){const s=await window.crypto.subtle.importKey("raw",e,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return new n(s)}static async generateRandomKey(){const e=await window.crypto.subtle.generateKey({name:"HMAC",hash:{name:"SHA-256"}},!0,["sign","verify"]);return new n(e)}}class a{constructor(e){this.key=e,this.ivGenerator=new M(window.crypto.getRandomValues(new Uint8Array(7)))}async encrypt(e){const s=this.ivGenerator.nextIv(),N=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:s,tagLength:128},this.key,e),B=new Uint8Array(N),q=new Uint8Array(r+B.length);return q.set(s),q.set(B,r),q}async decrypt(e){if(e.length<=r)throw new Error("encrypted data missing iv");const s=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:e.subarray(0,r),tagLength:128},this.key,e.subarray(r));return new Uint8Array(s)}async exportKey(){const e=await window.crypto.subtle.exportKey("raw",this.key);return new Uint8Array(e)}static async importKey(e){const s=await window.crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!1,["encrypt","decrypt"]);return new a(s)}static async generateRandomKey(){const e=await window.crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return new a(e)}}class w{randomBytes(e){const s=new Uint8Array(e);return window.crypto.getRandomValues(s)}importEncryptionKey(e){return a.importKey(e)}importSignatureKey(e){return n.importKey(e)}generateRandomEncryptionKey(){return a.generateRandomKey()}generateRandomSignatureKey(){return n.generateRandomKey()}}w$1.defaultCryptoImplementation=new w;function f(i){const e=i.indexOf("|");if(e===-1)throw new Error("missing separator between config and origin");return{serializedPeerSessionConfig:i.substring(0,e),parentOrigin:i.substring(e+1)}}class o{constructor(e){this.disposed=!1,this.callbacks=[],this.parentOrigin=e}sendMessageRaw(e){window.parent.postMessage(e,this.parentOrigin)}getEventCallback(e){for(const s of this.callbacks)if(s.encMessageCallback===e)return s.eventCallback}addMessageListener(e){if(this.getEventCallback(e))return;const s=N=>{if(N.origin===this.parentOrigin)try{e(N.data)}catch(B){console.error("ERROR in Event Callback: ",B)}};this.callbacks.push({encMessageCallback:e,eventCallback:s}),window.addEventListener("message",s,!1)}removeMessageListener(e){const s=this.getEventCallback(e);s&&(this.callbacks=this.callbacks.filter(N=>N.encMessageCallback!==e),window.removeEventListener("message",s,!1))}connect(e){return!0}canSendMessage(){return!this.disposed}dispose(){this.disposed||(this.disposed=!0,this.callbacks.forEach(e=>{window.removeEventListener("message",e.eventCallback,!1)}),this.callbacks=[])}}class t extends T{constructor(e,s,N=q=>console.error(q),B){super(e,s,N,B),this.channel=s}static async createWithOriginAndSessionConfig(e,s,N=q=>console.error(q),B){const q=_(s),V=await w$1.fromPeerSessionInfo(q),Y=new o(e);return new t(V,Y,N,B)}static async create(e={}){if(e.parentOrigin&&e.serializedPeerSessionConfig)return t.createWithOriginAndSessionConfig(e.parentOrigin,e.serializedPeerSessionConfig,e.onMessageHandlerError,e.onDecryptionError);{const s=window.location.hash;if(!s||s.length<2)throw new Error("missing peer session config in url hash");const{parentOrigin:N,serializedPeerSessionConfig:B}=f(decodeURIComponent(s.substring(1)));return t.createWithOriginAndSessionConfig(N,B,e.onMessageHandlerError,e.onDecryptionError)}}dispose(){super.dispose(),this.channel.dispose()}}async function C(i={}){const e=await t.create(i);return new z(e,i.serializer)}class InternalLogic{constructor(e){Ct(this,"peer");Ct(this,"name","");this.peer=e}hidden(){return"i am hidden"}}class ChildRPCHandlerClass extends InternalLogic{constructor(e){super(e)}async ping(e){return"pong_"+e}async executePrepared(e){return executePreparedBitIDEScript(e)}async compilePrepared(e){return compilePreparedBitIDEScript(e)}}function createLogHooks(i){const e={log:console.log,warn:console.warn,error:console.error};console.log=(...s)=>{e.log(...s),i(0,s)},console.warn=(...s)=>{e.warn(...s),i(1,s)},console.error=(...s)=>{e.error(...s),i(2,s)}}async function startChildRPC(){const e=(await C()).registerHandlerClass(s=>new ChildRPCHandlerClass(s));createLogHooks((s,N)=>{e.peer.log({level:s,values:N.map(B=>B+"")}).catch(B=>{})})}startChildRPC().then(()=>{}).catch(i=>{});
